# Linux性能优化

## 一、优化内核相关参数 ⚙️

- 内存管理参数
  - `vm.swappiness`：控制系统使用swap的倾向，默认60。若内存充足可调低至10，减少swap依赖。
  - `vm.dirty_ratio` / `vm.dirty_background_ratio`：控制写缓存刷新策略，避免高峰期大量I/O。推荐设置为20/10。
- 文件系统与句柄
  - `fs.file-max`：系统允许的最大文件句柄数，适合高并发应用，常调至10万以上。
- 网络参数
  - `net.core.somaxconn`：最大连接队列长度，默认128，建议调高至1024或更高以支持高并发服务。
- 持久化方法
  - 将参数写入`/etc/sysctl.conf`并执行`sysctl -p`加载 



## 二、提高资源限制上限 📈

- 文件句柄限制

  - 使用`ulimit -n`查看当前限制，默认可能只有1024。

  - 在

    ```
    /etc/security/limits.conf
    ```

    中配置：

    ```bash
    * soft nofile 65535
    * hard nofile 65535
    ```

- 进程数限制

  - `ulimit -u`控制单用户最大进程数，可根据应用需求调高。

- 栈大小与内存限制

  - `ulimit -s`调整栈大小，避免递归程序栈溢出。
  - `ulimit -m`可限制最大内存使用，通常不建议过低。

- 应用场景

  - 高并发Web服务、数据库、消息队列等场景需显著提高这些限制 



## 三、磁盘调度策略 💽

Linux支持多种I/O调度器，不同场景选择不同策略：

- noop

  - 简单FIFO队列，不做排序，适合SSD等无需优化寻道的设备。

- deadline

  - 保证请求在一定时间内完成，适合低延迟应用。

- cfq（已逐步淘汰）

  - 针对多进程公平调度，适合桌面环境。

- mq-deadline / kyber（现代内核）

  - 针对多队列设备优化，适合NVMe SSD和高并发场景。

- 切换方法

  ```bash
  cat /sys/block/sda/queue/scheduler   # 查看当前调度器
  echo deadline > /sys/block/sda/queue/scheduler
  ```

- 最佳实践

  - SSD：`noop`或`mq-deadline`
  - HDD：`deadline`
  - 高并发数据库：`deadline`或`kyber` 

## 一键优化脚本

```
#!/bin/bash
# Linux性能优化一键脚本

set -e

echo ">>> 开始Linux性能优化..."

### 一、优化内核参数 ###
echo ">>> 优化内核参数..."
cat <<EOF >> /etc/sysctl.conf

# 内存管理
vm.swappiness = 10
vm.dirty_ratio = 20
vm.dirty_background_ratio = 10

# 文件系统
fs.file-max = 2097152

# 网络优化
net.core.somaxconn = 1024
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 15
EOF

sysctl -p

### 二、提高资源限制 ###
echo ">>> 提高资源限制..."
cat <<EOF >> /etc/security/limits.conf
* soft nofile 65535
* hard nofile 65535
* soft nproc 65535
* hard nproc 65535
EOF

ulimit -n 65535
ulimit -u 65535

### 三、磁盘调度策略 ###
echo ">>> 设置磁盘调度策略..."
for disk in $(lsblk -nd --output NAME); do
    if [[ -e /sys/block/$disk/queue/scheduler ]]; then
        echo "deadline" > /sys/block/$disk/queue/scheduler
        echo ">>> $disk 调度器已设置为 deadline"
    fi
done

echo ">>> 优化完成！请重启服务或系统以确保生效。"

```



## 总结

- 内核参数优化 → 控制内存/网络行为，减少瓶颈。
- 资源限制提升 → 保证高并发应用不因系统默认限制崩溃。
- 磁盘调度策略 → 根据硬件特性选择最优算法，提升I/O性能。

