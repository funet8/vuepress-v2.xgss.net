# **å­˜å‚¨ï¼šPV / PVC / StorageClass åŠ¨æ€å­˜å‚¨ä¾›ç»™ï¼ˆK8s å­˜å‚¨æ ¸å¿ƒç¯‡ï¼‰**

åœ¨å®¹å™¨ç¼–æ’ä¸­ï¼Œ**æ•°æ®æŒä¹…åŒ–**æ°¸è¿œæ˜¯ç»•ä¸å¼€çš„è¯é¢˜ã€‚åº”ç”¨å¯ä»¥éšä¾¿é‡å¯ã€éšä¾¿è¿ç§»ï¼ŒPod è¯´æ²¡å°±æ²¡ï¼Œä½†æ•°æ®å¯ä¸èƒ½è¯´æ²¡å°±æ²¡ã€‚
 è¦è®© Kubernetes ä¸–ç•Œé‡Œçš„æ•°æ®â€œå®‰å±…ä¹ä¸šâ€ï¼Œæˆ‘ä»¬å°±è¦è®¤è¯†ä¸‰ä¸ªä¸»è§’ï¼š

- **PVï¼ˆPersistentVolumeï¼‰**ï¼šå­˜å‚¨èµ„æºçš„â€œæˆ¿ä¸œâ€
- **PVCï¼ˆPersistentVolumeClaimï¼‰**ï¼šPod çš„â€œç§Ÿæˆ¿éœ€æ±‚â€
- **StorageClass**ï¼šè‡ªåŠ¨å»ºæˆ¿ã€è‡ªåŠ¨åˆ†é…çš„â€œæˆ¿äº§ä¸­ä»‹ + å¼€å‘å•†â€

ä»Šå¤©æ˜Ÿå“¥å¸¦ä½ ä¸€æ¬¡ææ‡‚è¿™ä¸‰è€…ï¼Œé¡ºä¾¿æŠŠ **åŠ¨æ€å­˜å‚¨ä¾›ç»™ï¼ˆDynamic Provisioningï¼‰**ä¸€å¹¶æ‹¿ä¸‹ï¼ŒçœŸæ­£ä»é›¶åˆ°ç²¾é€šã€‚

------

# ğŸš€ 1. ä¸ºä»€ä¹ˆ K8s ä¸­éœ€è¦æŒä¹…åŒ–å­˜å‚¨ï¼Ÿ

åœ¨ Kubernetes ä¸­ï¼ŒPod çš„ç”Ÿå‘½å‘¨æœŸæçŸ­ï¼š

- è‡ªåŠ¨æ‰©ç¼©å®¹
- æ»šåŠ¨æ›´æ–°
- èŠ‚ç‚¹æ¼‚ç§»
- é‡å¯å³å¤±å¿†ï¼ˆEphemeralï¼‰

å¦‚æœä½ çš„åº”ç”¨æ²¡æœ‰çŠ¶æ€è¿˜å¥½è¯´ï¼Œä½†æ•°æ®åº“ã€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—å¯å—ä¸äº†ã€‚
 äºæ˜¯ï¼ŒK8s å¿…é¡»æä¾›ä¸€ç§**è·Ÿ Pod ç”Ÿå‘½å‘¨æœŸæ— å…³**çš„å­˜å‚¨æœºåˆ¶ï¼Œè¿™å°±æ˜¯ PV / PVCã€‚

------

# ğŸ§± 2. PVï¼ˆPersistentVolumeï¼‰ï¼šé›†ç¾¤é‡Œçš„â€œå­˜å‚¨èµ„äº§â€

PV æ˜¯ç”±ç®¡ç†å‘˜æå‰åˆ›å»ºçš„å­˜å‚¨èµ„æºï¼Œç±»ä¼¼ï¼š

- ä¸€ä¸ª NFS çš„ç›®å½•
- ä¸€ä¸ªäº‘ç›˜ï¼ˆå¦‚é˜¿é‡Œäº‘ ESSDã€è…¾è®¯äº‘ CFSï¼‰
- ä¸€ä¸ª Ceph RBD
- ä¸€ä¸ªæœ¬åœ°ç£ç›˜è·¯å¾„

å®ƒçš„ç‰¹ç‚¹æ˜¯ï¼š

- ç‹¬ç«‹äº Namespace
- ç”Ÿå‘½å‘¨æœŸä¸ä¾èµ– Pod
- æ‹¥æœ‰å®¹é‡ã€è®¿é—®æ¨¡å¼ã€å›æ”¶ç­–ç•¥ç­‰å±æ€§

**ä¾‹å­ï¼šä¸€ä¸ª 10Gi çš„ NFS PV**

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-nfs
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteMany
  nfs:
    path: /data/k8s
    server: 10.0.0.10
  persistentVolumeReclaimPolicy: Retain
```

------

# ğŸ“ 3. PVCï¼ˆPersistentVolumeClaimï¼‰ï¼šPod çš„â€œç§Ÿæˆ¿éœ€æ±‚â€

åº”ç”¨ä¸ä¼šç›´æ¥æ‰¾ PVï¼Œè€Œæ˜¯å‘å‡ºä¸€ä¸ªéœ€æ±‚ï¼šæˆ‘è¦ 10Giã€æˆ‘è¦ RWXã€æˆ‘è¦èƒ½å¤š Pod æŒ‚è½½ã€‚

K8s ä¼šè‡ªåŠ¨å¸®ä½ åŒ¹é…**åˆé€‚çš„ PV**ã€‚

ç¤ºä¾‹ï¼š

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-test
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
```

PVC åŒ¹é…åˆ° PV åï¼Œä¼šè¿›è¡Œç»‘å®šï¼ˆBoundï¼‰ï¼Œç„¶å Pod å°±èƒ½ä½¿ç”¨å®ƒï¼š

```yaml
volumes:
  - name: data
    persistentVolumeClaim:
      claimName: pvc-test
```

------

# ğŸ— 4. StorageClassï¼šè‡ªåŠ¨é€ æˆ¿å­çš„â€œå¼€å‘å•†â€

å¦‚æœæ¯æ¬¡ä½¿ç”¨å‰éƒ½å¾—è¿ç»´ç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»º PVï¼Œé‚£ Kubernetes å°±ä¸å¤Ÿâ€œäº‘åŸç”Ÿâ€äº†ã€‚

**StorageClass è®©ä½ åšåˆ°ï¼š
 PVC ä¸€åˆ›å»ºï¼ŒPV è‡ªåŠ¨ç”Ÿæˆï¼Œåº•å±‚å­˜å‚¨è‡ªåŠ¨åˆ†é…ã€‚**

åŠ¨æ€ä¾›ç»™æ¶æ„ï¼š

```
PVC ---> StorageClass ---> Provisioner ---> PV
```

æ¯”å¦‚åœ¨äº‘å¹³å°ä¸Šï¼ŒProvisioner ä¼šè‡ªåŠ¨åˆ›å»ºçœŸå®çš„ç£ç›˜ã€‚

------

# ğŸ›  5. åŠ¨æ€å­˜å‚¨ä¾›ç»™ï¼ˆDynamic Provisioningï¼‰

åŠ¨æ€å­˜å‚¨ä¾›ç»™ï¼Œéœ€è¦ä¸¤ä¸ªæ¡ä»¶ï¼š

1. å®šä¹‰ StorageClass
2. PVC æŒ‡å®š StorageClass åç§°

è¿™æ · K8s æ‰çŸ¥é“è¯¥è®©å“ªä¸ª Provisioner å»åˆ›å»ºç£ç›˜ã€‚

## ç¤ºä¾‹ StorageClassï¼ˆä»¥é˜¿é‡Œäº‘ä¸ºä¾‹ï¼‰

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: alicloud-essd
provisioner: alicloud/disk
parameters:
  type: "cloud_essd"
reclaimPolicy: Delete
volumeBindingMode: Immediate
```

## PVC ä½¿ç”¨ StorageClass

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-essd
spec:
  storageClassName: alicloud-essd
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
```

PVC ä¸€åˆ›å»º â†’ äº‘ç›˜è‡ªåŠ¨åˆ›å»º â†’ PV è‡ªåŠ¨ç”Ÿæˆ â†’ è‡ªåŠ¨ç»‘å®šã€‚
 çœŸæ­£åšåˆ°äº†â€œå³ç”¨å³å¼€ï¼Œå³åˆ å³å›æ”¶â€ã€‚

------

# ğŸªœ 6. ä¸‰è€…å…³ç³»æ€»ç»“ï¼ˆæœ€å¸¸è§çš„é¢è¯•é¢˜ï¼‰

ä¸‹é¢æ˜¯ä¸€å¥è¯æ€»ç»“ï¼š

- **PVï¼šæˆ¿ä¸œ â†’ å­˜å‚¨èµ„æº**
- **PVCï¼šç§Ÿå®¢ â†’ æå‡ºéœ€æ±‚**
- **StorageClassï¼šæˆ¿äº§ä¸­ä»‹ â†’ åŠ¨æ€å»ºæˆ¿åŒ¹é…**

å…³ç³»å›¾ï¼š

```
[StorageClass] --(åˆ›å»ºPV)--> [PV] <--(ç»‘å®š)--> [PVC] <--(æŒ‚è½½)--> [Pod]
```

é¢è¯•å®˜æœ€çˆ±é—®ï¼š

> **ç›´æ¥ä½¿ç”¨ NFS hostPath ä¸è¡Œå—ï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨ PV/PVCï¼Ÿ**

å› ä¸º PV/PVC æ˜¯ Kubernetes æ ‡å‡†åŒ–çš„å­˜å‚¨æŠ½è±¡ï¼Œå¯ä»¥æ›¿æ¢åº•å±‚å­˜å‚¨ã€æ”¯æŒè°ƒåº¦ã€æ”¯æŒåŠ¨æ€ä¾›ç»™ã€æ”¯æŒè·¨äº‘å¹³å°ä¸€è‡´æ€§ã€‚

------

# ğŸ”¥ 7. é€‰æ‹©å“ªç§è®¿é—®æ¨¡å¼ï¼ˆAccessModeï¼‰ï¼Ÿ

æ ¹æ®åº”ç”¨éœ€è¦é€‰æ‹©ï¼š

| AccessMode              | å«ä¹‰         | åœºæ™¯               |
| ----------------------- | ------------ | ------------------ |
| **RWO** (ReadWriteOnce) | å•èŠ‚ç‚¹å¯è¯»å†™ | æ•°æ®åº“ã€å•å®ä¾‹æœåŠ¡ |
| **ROX** (ReadOnlyMany)  | å¤šèŠ‚ç‚¹åªè¯»   | é•œåƒåº“ã€å†…å®¹åˆ†å‘   |
| **RWX** (ReadWriteMany) | å¤šèŠ‚ç‚¹å¯è¯»å†™ | Web å¤šå®ä¾‹å…±äº«å­˜å‚¨ |

äº‘ç›˜ä¸€èˆ¬åªæ”¯æŒ **RWO**ï¼Œæƒ³è¦å¤š Pod å…±äº«è¦ç”¨ NFSã€CephFS ç­‰ã€‚

------

# ğŸ’¡ 8. PV å›æ”¶ç­–ç•¥é€‰ä»€ä¹ˆï¼Ÿ

PV ç”¨å®Œä¹‹åå¦‚ä½•å¤„ç†ï¼Ÿ

| ç­–ç•¥        | è¯´æ˜                     | åœºæ™¯             |
| ----------- | ------------------------ | ---------------- |
| **Retain**  | ä¿ç•™æ•°æ®ã€ä¸è‡ªåŠ¨åˆ é™¤     | æ•°æ®åº“ç­‰é‡è¦åœºæ™¯ |
| **Delete**  | åˆ é™¤ PV å’Œåº•å±‚å­˜å‚¨       | äº‘ç›˜æœ€å¸¸ç”¨       |
| **Recycle** | NFS æ¸…ç©ºåé‡ç”¨ï¼ˆå·²å¼ƒç”¨ï¼‰ | ä¸æ¨è           |

ç”Ÿäº§ç¯å¢ƒä¸€èˆ¬ç”¨ï¼š

- åŠ¨æ€åˆ›å»º â†’ Delete
- æ‰‹å·¥åˆ›å»º â†’ Retain

------

# ğŸ§© 9. å®æˆ˜ï¼šéƒ¨ç½²ä¸€ä¸ªå¸¦æŒä¹…åŒ–çš„ Nginx

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-nginx
spec:
  storageClassName: nfs-sc
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
      volumes:
      - name: html
        persistentVolumeClaim:
          claimName: pvc-nginx
```

å†…å®¹æŒä¹…å­˜å‚¨ â†’ Pod é‡å¯ä¸ä¸¢ â†’ å¤šå®ä¾‹å…±äº«ã€‚

------

# ğŸ æœ€å

Kubernetes çš„å­˜å‚¨ä½“ç³»éå¸¸çµæ´»ï¼š

- æœ‰çŠ¶æ€åº”ç”¨ï¼ˆStatefulSetï¼‰ä¾èµ– PVC
- åŠ¨æ€ä¾›ç»™è®©å­˜å‚¨è‡ªåŠ¨åŒ–
- StorageClass è§£è€¦äº†åº•å±‚å­˜å‚¨
- PV/PVC æŠ½è±¡è®©è·¨äº‘ä¸€è‡´æ€§æˆä¸ºå¯èƒ½

