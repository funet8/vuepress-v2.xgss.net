# API自动化：Requests/Python 调用 RESTful API 管理运维任务

在现代运维体系中，自动化已经不再是锦上添花，而是效率与稳定的核心。无论是服务器资源管理、监控告警、批量执行任务，还是CI/CD流程编排，API（尤其是 RESTful API）都扮演着关键角色。通过 Python 的 `requests` 库，我们可以轻松实现基于 API 的自动化运维任务，让运维工作更智能、更规范、更具扩展性。



## 一、为什么运维要用 API 自动化？

相比脚本直连服务器（如SSH）或手工操作后台系统，API 自动化的优势明显：

| 对比维度     | API自动化                  | SSH脚本操作 | 后台手工操作 |
| ------------ | -------------------------- | ----------- | ------------ |
| 安全性       | 高（Token、JWT、TLS）      | 较低        | 中等         |
| 可维护性     | 高（标准化接口）           | 低          | 低           |
| 扩展性       | 强                         | 较弱        | 较弱         |
| 执行效率     | 高                         | 中          | 低           |
| 可观测性     | 接口日志、响应码           | 模糊        | 弱           |
| 适配系统类型 | 支持云平台、Docker、K8s 等 | 限传统主机  | 限平台功能   |

像阿里云、腾讯云、Grafana、Prometheus、Ansible Tower、JumpServer 等系统都提供了 RESTful API，运维人员可以用 Python 发起请求完成“创建主机、重启服务、查监控、执行作业”等操作，从而实现系统对系统的自动化。

------

## 二、Requests 调用 RESTful API 的基础

### 1. 安装 Requests

```bash
pip install requests
```

### 2. 基本请求示例

```python
import requests

url = "https://api.example.com/v1/server/list"
headers = {
    "Authorization": "Bearer YOUR_API_TOKEN",
    "Content-Type": "application/json"
}

response = requests.get(url, headers=headers)
print(response.status_code)
print(response.json())
```

### 3. 常见请求方法（REST标准）

| HTTP方法 | 用途                 |
| -------- | -------------------- |
| GET      | 查询信息             |
| POST     | 创建资源             |
| PUT      | 更新资源（整体覆盖） |
| PATCH    | 部分更新             |
| DELETE   | 删除资源             |

------

## 三、典型运维任务：调用 API 实战演练

### 样例环境：某运维管理平台提供以下接口：

| 操作         | URL                        | 方法 |
| ------------ | -------------------------- | ---- |
| 获取主机列表 | `/api/v1/hosts`            | GET  |
| 创建主机资产 | `/api/v1/hosts`            | POST |
| 执行远程命令 | `/api/v1/job/execute`      | POST |
| 获取监控数据 | `/api/v1/prometheus/query` | GET  |

------

### 1. 获取主机资产列表（GET）

```python
import requests

url = "https://ops.example.com/api/v1/hosts"
headers = {"Authorization": "Token abc123"}

response = requests.get(url, headers=headers)

if response.status_code == 200:
    for host in response.json()["data"]:
        print(host["id"], host["hostname"], host["ip"])
else:
    print("查询失败：", response.status_code)
```

------

### 2. 创建一台资产主机（POST + JSON）

```python
import requests
import json

url = "https://ops.example.com/api/v1/hosts"
headers = {
    "Authorization": "Token abc123",
    "Content-Type": "application/json"
}

payload = {
    "hostname": "db-server-01",
    "ip": "10.0.0.15",
    "os": "CentOS 7",
    "owner": "Ops Team"
}

response = requests.post(url, headers=headers, data=json.dumps(payload))
print(response.json())
```

------

### 3. 批量执行远程命令（POST）

```python
import requests

def run_remote_command(host_ids, command):
    url = "https://ops.example.com/api/v1/job/execute"
    headers = {"Authorization": "Token abc123", "Content-Type": "application/json"}
    payload = {
        "hosts": host_ids,
        "command": command
    }

    response = requests.post(url, headers=headers, json=payload)

    if response.status_code == 200:
        job_id = response.json()["job_id"]
        print(f"任务已提交，Job ID: {job_id}")
        return job_id
    else:
        print("任务执行失败：", response.status_code)

run_remote_command(["12","43","87"], "systemctl restart nginx")
```

------

### 4. 查询监控数据 (Prometheus API)

```python
import requests

base_url = "http://monitor.example.com/api/v1/query"
params = {"query": 'node_load1'}

response = requests.get(base_url, params=params)

if response.status_code == 200:
    data = response.json()["data"]["result"]
    for item in data:
        print(item["metric"]["instance"], item["value"])
else:
    print("查询失败")
```

------

## 四、如何封装成通用运维 API 调用框架？

在生产环境，建议封装一套通用 API 基类：

```python
import requests

class OpsAPI:
    def __init__(self, base_url, token):
        self.base_url = base_url.rstrip('/')
        self.headers = {
            "Authorization": f"Token {token}",
            "Content-Type": "application/json"
        }

    def request(self, method, endpoint, **kwargs):
        url = f"{self.base_url}{endpoint}"
        response = requests.request(method, url, headers=self.headers, **kwargs)
        if response.status_code >= 400:
            raise Exception(f"请求失败: {response.status_code}, {response.text}")
        return response.json()

# 使用示例
api = OpsAPI("https://ops.example.com", "abc123")

print(api.request("GET", "/api/v1/hosts"))
api.request("POST", "/api/v1/job/execute", json={"hosts":["1"], "command":"uptime"})
```

------

## 五、进阶优化建议

| 优化方向           | 可采用方案                       |
| ------------------ | -------------------------------- |
| 并发执行 API       | `ThreadPoolExecutor` / `aiohttp` |
| 加入重试机制       | `requests.adapters.HTTPAdapter`  |
| 日志 & 审计        | logging模块 + 请求响应保存       |
| 安全处理 Token     | 使用 Vault / 环境变量 / 加密文件 |
| 对接企业微信等告警 | API + Webhook                    |

------

## 六、总结：API 是运维自动化的核心连接器

> **一句话总结：API 是系统之间的“桥梁”，Python 是自动化的“工具臂”。**

通过 Requests 调用 RESTful API，我们可以轻松构建自动化运维体系，实现：

- 资产管理自动化
- 作业批量执行
- 监控查询与告警处理
- CI/CD 与 DevOps 编排
- 云平台资源管理（服务器、容器、数据库）

只要一个 HTTP 请求，就能触发强大的自动化流程。



