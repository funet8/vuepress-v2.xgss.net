

# Squid代理搭建全指南

## 1️⃣ 前言

在网络运维与安全领域，**代理服务器**是流量调度、访问控制和缓存加速的重要工具。
 **Squid** 作为开源、高性能的 HTTP/HTTPS/FTP 缓存代理，广泛应用于企业内网、教育网络、爬虫集群等场景。
 本文将从 **原理 → 安装 → 配置 → 优化 → 安全加固** 全流程讲解，帮助你快速搭建可用、稳定且安全的 Squid 代理服务。

------

## 2️⃣ Squid 工作原理概述

- **代理转发**：客户端请求 → Squid → 目标服务器 → Squid → 客户端
- **缓存机制**：对静态资源（HTML、CSS、JS、图片等）进行本地缓存，减少重复请求
- **访问控制**：通过 ACL（Access Control List）限制访问来源、目标域名、时间段等
- **协议支持**：HTTP、HTTPS（需 CONNECT 隧道）、FTP 等

**架构示意**：

```
[Client] ⇄ [Squid Proxy] ⇄ [Internet]
```

------

## 3️⃣ 环境准备

| 项目 | 推荐配置                     |
| ---- | ---------------------------- |
| 系统 | Ubuntu 20.04 / CentOS 7+     |
| 内存 | ≥ 1GB（缓存多建议 4GB+）     |
| 磁盘 | ≥ 10GB（缓存目录需额外空间） |
| 网络 | 公网 IP（或内网测试环境）    |

------

## 4️⃣ 安装 Squid

### Ubuntu/Debian

```bash
sudo apt update
sudo apt install squid -y
```

### CentOS/RHEL

```bash
sudo yum install squid -y
```

安装完成后，主配置文件路径：

```
/etc/squid/squid.conf
```

------

## 5️⃣ 基础配置

### 5.1 修改监听端口

默认端口为 **3128**，可在 `squid.conf` 中修改：

```conf
http_port 3128
```

### 5.2 设置访问控制（ACL）

示例：仅允许特定 IP 段访问

```conf
acl allowed_ips src 192.168.1.0/24
http_access allow allowed_ips
http_access deny all
```

### 5.3 启用缓存目录

```conf
cache_dir ufs /var/spool/squid 100 16 256
```

- `100`：缓存大小（MB）
- `16`、`256`：目录层级

### 5.4 启动与开机自启

```bash
sudo systemctl enable squid
sudo systemctl start squid
```

------

## 6️⃣ HTTPS 代理支持（隧道模式）

Squid 默认支持 HTTP，若需 HTTPS：

```conf
acl SSL_ports port 443
acl CONNECT method CONNECT
http_access allow CONNECT SSL_ports
```

客户端需配置为 **HTTP 代理**，访问 HTTPS 时会自动使用 CONNECT 隧道。

------

## 7️⃣ 性能优化建议

- **增加缓存内存**：

```conf
cache_mem 256 MB
```

- **调整文件描述符**：

```bash
ulimit -n 65535
```

- **开启多进程/多线程**（高并发场景）：

```conf
workers 4
```

- **合理设置缓存策略**：

```conf
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
```

------

## 8️⃣ 安全加固

- **限制来源 IP**（避免被滥用）
- **启用认证**：

```conf
auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwd
auth_param basic realm Squid Proxy
acl authenticated proxy_auth REQUIRED
http_access allow authenticated
```

生成用户密码：

```bash
sudo apt install apache2-utils -y
htpasswd -c /etc/squid/passwd user1
```

- **定期更新系统与 Squid**
- **监控日志**：

```bash
tail -f /var/log/squid/access.log
```

------

## 9️⃣ 常见问题排查

| 问题             | 可能原因               | 解决方案       |
| ---------------- | ---------------------- | -------------- |
| 代理无法访问外网 | 防火墙阻挡             | 开放 3128 端口 |
| HTTPS 报错       | CONNECT 未配置         | 检查 ACL       |
| 缓存无效         | refresh_pattern 不匹配 | 调整规则       |

------

## 🔟 总结

Squid 作为成熟的代理解决方案，具备 **高性能、可扩展、可控性强** 的优势。
 通过合理配置 ACL、缓存策略与安全加固措施，可以在企业、教育、爬虫等多种场景中稳定运行。

