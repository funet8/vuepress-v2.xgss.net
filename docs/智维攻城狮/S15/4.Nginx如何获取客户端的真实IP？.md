# Nginx如何获取客户端的真实IP？



# Nginx获取客户端真实IP完全指南：从原理到实战配置


## 引言

在现代互联网架构中，**反向代理技术**已成为提升网站性能与可靠性的核心组件。作为全球最流行的 Web 服务器之一，Nginx 以其高性能、低资源占用及灵活性著称，目前已被部署在超过 3 亿个网站上。这种普及性源于其作为反向代理服务器的卓越表现——能够有效分发流量、缓存静态资源并增强后端服务安全性[[1](http://blog.wya1.com/article/2068800324/details/37229)]。

然而，反向代理的广泛应用也带来了**客户端真实 IP 获取的挑战**。当 Nginx 或 CDN 服务作为中间层时，服务器日志通常记录的是代理节点 IP 而非原始请求来源。例如，某网站接入 Cloudflare CDN 后，所有访问日志均显示为 Cloudflare 的节点 IP，导致无法直接追溯真实用户地址；同时 Cloudflare 控制台仅支持查看 24 小时内的访问记录，难以满足批量日志分析需求[[2](https://blog.csdn.net/zhuannnn/article/details/145565782)]。这种信息缺失直接影响日志审计、访问控制策略制定及安全事件溯源的准确性。

**核心需求**：准确获取客户端真实 IP 是实现精细化运维的基础——无论是用户行为分析、异常流量监控，还是基于 IP 的访问限制与合规审计，均依赖这一关键数据。在多代理架构下，如何穿透层层转发还原真实地址，已成为运维与开发人员的必备技能。

本文将构建一套**从原理到实战的完整解决方案**，系统讲解 Nginx 反向代理场景下 IP 传递的底层机制，提供跨场景配置指南（含 CDN、多级代理等复杂环境），并结合实战案例与安全最佳实践，帮助技术人员彻底解决真实 IP 获取难题。

## Nginx反向代理下的IP问题原理


### 反向代理如何隐藏客户端IP

反向代理作为客户端与后端服务器之间的中间节点，其核心转发机制会导致后端服务器无法直接获取客户端真实IP。从网络通信原理来看，这种隐藏效应源于代理服务器在**传输层**和**应用层**的双重处理机制。

在**传输层（TCP/IP协议栈）**，客户端发起的请求首先与反向代理服务器建立TCP连接，代理服务器再以自身名义与后端服务器建立新的TCP连接。这种**连接重建过程**使得后端服务器的TCP连接对象始终是代理服务器，因此从IP报文头部的`src`字段中只能解析出代理服务器的IP。此外，代理服务器通常会执行**网络地址转换（NAT）**，主动替换IP报文的源地址字段，进一步强化对客户端IP的隐藏效果[[6](https://docs.fortinet.com/document/fortiweb/7.0.2/cli-reference/577849/waf-x-forwarded-for)]。

在**应用层（HTTP协议）**，代理服务器转发请求时默认不会主动传递客户端IP信息。后端服务器通过`remote_addr`等标准字段获取的IP地址，本质上是TCP连接的对端IP（即代理服务器IP）。例如，未配置特殊模块时，Nginx的`access_log`日志和PHP的`$_SERVER['REMOTE_ADDR']`变量均会记录反向代理的IP[[7](https://blog.csdn.net/weixin_34006965/article/details/91794862)]。

**无代理与有代理场景的IP记录差异**  

- **无代理场景**：客户端直接与后端服务器建立TCP连接，`remote_addr`字段直接反映真实客户端IP（如`100.100.100.1`）。  
- **有代理场景**：代理服务器作为中间人重建连接，后端服务器的`remote_addr`、日志记录及应用层变量均显示代理IP（如CDN节点IP `192.168.1.100`）。

### X-Forwarded-For与X-Real-IP的作用与区别

X-Forwarded-For（XFF）和X-Real-IP均为HTTP请求头字段，用于代理服务器向后端服务器传递客户端真实IP地址。两者在格式、信息完整性及适用场景上存在显著差异。

#### 一、核心差异对比

| **维度**     | **X-Forwarded-For**                                          | **X-Real-IP**                                                |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **格式**     | 逗号分隔的IP列表，格式为`客户端IP, 代理1IP, 代理2IP...`      | 单个IP地址，格式为`客户端IP`或`直接连接的代理IP`             |
| **包含信息** | 记录完整代理链，第一个IP为原始客户端真实IP，后续为各级代理服务器IP | 仅包含单个IP，通常为最靠近源站的上一级代理IP（默认行为）     |
| **适用场景** | 多级代理架构，需追溯完整请求路径（如CDN+负载均衡+应用服务器） | 单级代理或简单架构，仅需传递最终客户端IP                     |
| **安全性**   | 可被客户端伪造（需通过`set_real_ip_from`等配置限定信任代理IP段）[[14](https://github.com/sozu-proxy/sozu/issues/1113)] | 依赖代理配置，若第一层代理正确设置客户端IP且后续代理透传，则安全性较高 |

#### 二、实例解析：两级代理场景下的表现

当请求经过**客户端 → 代理1 → 代理2 → 源站**的两级代理链路时：

- **X-Forwarded-For**：值为`203.0.113.1, 198.51.100.1, 172.16.0.1`（客户端IP, 代理1IP, 代理2IP）
- **X-Real-IP**：值为`172.16.0.1`（仅代理2IP，默认行为）

**关键结论**：无论选择哪种头字段，核心是通过**信任链设计**（限定可信代理IP）和**代理配置一致性**确保IP传递的真实性。X-Forwarded-For提供完整路径但需严格校验，X-Real-IP简化传递但依赖代理规范执行。

## ngx_http_realip_module模块详解


### 模块作用与编译安装

在反向代理或多级代理架构中，Nginx 默认通过 `$remote_addr` 变量记录直接连接方的 IP 地址，这导致该变量在代理场景下会被替换为**代理服务器的 IP**，而非真实客户端 IP。ngx_http_realip_module 模块的核心功能是**从信任的代理服务器传递的 HTTP 请求头中提取真实客户端 IP，并覆盖 `$remote_addr` 变量的值**。

#### 编译安装步骤

ngx_http_realip_module 模块**默认不随 Nginx 编译安装**，需通过源码编译时手动指定启用：

1. **下载源码**  

   ```bash
   wget http://nginx.org/download/nginx-1.26.0.tar.gz
   ```

2. **解压并配置编译参数**  

   ```bash
   tar -zxvf nginx-1.26.0.tar.gz
   cd nginx-1.26.0/
   ./configure --prefix=/usr/local/nginx \
     --with-http_ssl_module \
     --with-http_realip_module  # 启用realip模块
   ```

3. **编译与安装**  

   ```bash
   make && make install
   ```

#### 验证安装

```bash
/usr/local/nginx/sbin/nginx -V 2>&1 | grep "realip"
```

若输出包含 `--with-http_realip_module`，则表示模块已启用。

### 核心指令解析

#### set_real_ip_from

**作用**：定义可信代理服务器的IP地址或网段，仅来自这些来源的请求才会触发真实IP重写逻辑。  
**语法**：`set_real_ip_from <address | CIDR | unix>`  
**示例**：

```nginx
set_real_ip_from 10.0.0.5;          # 单个代理IP
set_real_ip_from 192.168.1.0/24;     # IP网段
set_real_ip_from 2001:0db8::/32;     # IPv6网段
```

#### real_ip_header

**作用**：指定从哪个HTTP请求头提取客户端真实IP。  
**语法**：`real_ip_header <field | X-Real-IP | X-Forwarded-For>`  
**示例**：

```nginx
real_ip_header X-Forwarded-For;      # 从XFF头提取IP链
real_ip_header CF-Connecting-IP;     # Cloudflare专用头
```

#### real_ip_recursive

**作用**：控制是否递归排除信任代理IP，解决多级代理场景下的IP识别问题。  
**语法**：`real_ip_recursive on | off`  

**关键逻辑对比**：假设`X-Forwarded-For: 103.21.244.1（客户端）, 10.0.0.5（代理1）, 10.0.0.7（代理2）`，且已信任10.0.0.5和10.0.0.7：

- `real_ip_recursive off` → 取最后一个IP（10.0.0.7，错误）
- `real_ip_recursive on` → 排除信任IP，取103.21.244.1（正确）

### 内置变量与应用场景

#### 核心变量对比

| **变量**              | **说明**                                                   |
| --------------------- | ---------------------------------------------------------- |
| `$remote_addr`        | 处理后的客户端真实IP（经realip模块转换）                   |
| `$realip_remote_addr` | 保留原始客户端地址（不受realip模块影响，Nginx 1.9.7+支持） |

#### 典型应用场景

**1. 日志记录原始IP**  

```nginx
log_format combined_realip '$remote_addr [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$realip_remote_addr"';
access_log /var/log/nginx/access.log combined_realip;
```

**2. IP白名单访问控制**  

```nginx
location /sensitive-api {
    allow 192.168.1.0/24;  # 仅允许特定IP访问
    deny all;
    proxy_pass http://backend_server;
}
```

## 配置实战：从单级代理到CDN环境


### 单级代理配置

#### 拓扑说明  

**客户端 → 代理服务器 → 后端Nginx**，需配置代理服务器传递IP头，后端Nginx信任代理IP并提取真实IP。

#### 配置代码  

**1. 代理服务器配置**  

```nginx
server {
    listen 80;
    location / {
        proxy_pass http://后端NginxIP:端口;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # 传递IP链
        proxy_set_header X-Real-IP $remote_addr;  # 传递客户端IP
    }
}
```

**2. 后端Nginx配置**  

```nginx
server {
    listen 80;
    # 声明可信代理IP
    set_real_ip_from 192.168.1.0/24;  # 代理服务器IP段
    real_ip_header X-Forwarded-For;   # 从XFF头提取IP链
    real_ip_recursive on;             # 启用递归排除

    location / {
        proxy_pass http://backend_server;
    }
}
```

### 多级代理配置

#### 配置要点  

多级代理需确保每级代理正确传递`X-Forwarded-For`头，后端服务器声明所有上游代理IP为可信，并启用递归解析。

#### 分步配置  

**1. 上游代理配置**（每级代理均需添加）  

```nginx
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
```

**2. 后端服务器配置**  

```nginx
server {
    listen 80;
    # 信任所有上游代理IP
    set_real_ip_from 10.0.0.5;  # 代理1
    set_real_ip_from 10.0.0.6;  # 代理2
    set_real_ip_from 10.0.0.7;  # 代理3
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;  # 递归排除可信IP
}
```

### CDN环境特殊配置

#### Cloudflare CDN配置  

1. **获取官方IP段**  
   IPv4: `https://www.cloudflare.com/ips-v4`  
   IPv6: `https://www.cloudflare.com/ips-v6`

2. **Nginx配置示例**  

   ```nginx
   # 引入Cloudflare IP段配置
   include /etc/nginx/cloudflare-ips.conf;
   real_ip_header CF-Connecting-IP;  # 使用Cloudflare专用头
   ```

#### 自动化IP段更新脚本  

```bash
#!/bin/bash
# 下载并生成Cloudflare IP段配置
curl -s https://www.cloudflare.com/ips-v4 | awk '{print "set_real_ip_from " $0 ";"}' > /etc/nginx/cloudflare-ips.conf
nginx -t && systemctl reload nginx  # 验证并重载Nginx
```

## 安全最佳实践


### 信任IP的精细化配置

#### 配置原则  

遵循**最小权限原则**，仅将直接对接的代理服务器IP或IP段加入信任列表，支持格式：

- 单个IP：`set_real_ip_from 192.168.2.1;`
- CIDR网段：`set_real_ip_from 203.0.113.0/24;`

#### 风险对比

| 配置类型   | 示例                          | 风险等级 | 适用场景             |
| ---------- | ----------------------------- | -------- | -------------------- |
| 精确IP段   | `set_real_ip_from 4.4.4.4/24` | 低       | 已知代理服务器集群   |
| 通配符网段 | `set_real_ip_from 0.0.0.0/0`  | 极高     | 无（任何场景均禁止） |

**关键安全实践**  

1. 定期更新信任IP列表：CDN或云服务商IP段可能变更，需通过自动化工具同步官方IP列表[[18](https://www.getpagespeed.com/server-setup/nginx/cloudflare-and-nginx-automatic-sync-of-cloudflare-trusted-ip-addresses/amp)]。  
2. 禁止源站直接暴露：通过配置默认站点返回444错误，阻止攻击者绕过代理直接访问源站IP[[25](https://blog.csdn.net/qq_73617452/article/details/147594026)]。  

## 常见问题排查


### 配置不生效的核心原因

#### 模块未启用  

**现象**：启动时报`unknown directive "set_real_ip_from"`  
**验证**：`nginx -V | grep realip`，确认输出包含`--with-http_realip_module`

#### 信任IP配置不完整  

**现象**：获取的IP为代理IP而非客户端真实IP  
**验证**：对比`set_real_ip_from`配置与实际代理IP，确保包含所有上游代理IP段

#### real_ip_recursive设置不当  

**现象**：多级代理场景下IP提取错误  
**建议**：多级代理必须设置`real_ip_recursive on`，单级代理可设为`off`

### 排查工具与命令

- **验证配置语法**：`nginx -t`  
- **实时监控日志**：`tail -f /var/log/nginx/access.log`  
- **临时响应头调试**：`add_header X-Real-IP $realip_remote_addr;`

## 总结

本文系统讲解了Nginx获取客户端真实IP的完整解决方案，核心配置逻辑可凝练为**信任IP界定、HTTP头传递与递归参数配置**三大要素。不同网络架构下的配置策略差异显著：单层级代理需重点关注信任IP与HTTP头匹配；多层级代理或CDN环境则需启用递归解析并验证全链路头传递的完整性。

**建议**：在实际部署中，应优先通过架构梳理明确代理层级与厂商特性，选择符合RFC标准的`X-Forwarded-For`头作为主流方案，同时辅以`real_ip_recursive on`确保递归解析。配置完成后需通过日志审计和模拟请求测试验证有效性，并建立季度周期的配置审查机制。

