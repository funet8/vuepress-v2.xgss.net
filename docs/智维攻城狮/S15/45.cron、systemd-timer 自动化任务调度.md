# 定时任务管理：cron / systemd-timer 自动化任务调度

在 Linux 系统中，自动化运维的第一步是什么？大多数人都会回答：**定时任务**。
 无论是每天自动备份数据库、每小时同步日志，还是每月清理过期文件，稳定可靠的定时调度系统都是不可或缺的。

今天我们来系统讲讲 Linux 中两种主流的定时任务工具：**cron** 和 **systemd timer** ——前者历史悠久，简单易用；后者现代强大、日志清晰。
 学会它们，你就真正掌握了 Linux 自动化调度的核心能力。

------

## 一、cron：经典且高效的定时任务工具

### 1. cron 的核心机制

cron 是 Linux 系统默认的任务调度工具，通过解析 crontab 文件中的表达式，在指定时间执行指定命令。

时间表达式格式如下：

```
*    *    *    *    *    command
分   时   日   月   周   执行的命令
```

示例：每天凌晨 3 点备份数据库

```bash
0 3 * * * /usr/local/bin/db_backup.sh
```

------

### 2. 管理方式

| 命令                   | 功能                     |
| ---------------------- | ------------------------ |
| crontab -e             | 编辑当前用户的 cron 任务 |
| crontab -l             | 查看任务                 |
| crontab -r             | 删除所有任务             |
| systemctl status crond | 查看 cron 服务状态       |

------

### 3. cron 常见优化

#### ➤ 设置 PATH 环境变量

```bash
PATH=/usr/sbin:/usr/bin:/bin:/usr/local/bin
```

#### ➤ 写日志方便排查问题

```bash
0 3 * * * /usr/local/bin/db_backup.sh >> /var/log/db_backup.log 2>&1
```

#### ➤ 防止任务重复执行

使用 `flock`

```bash
*/5 * * * * flock -n /tmp/task.lock /usr/local/bin/task.sh
```

------

### 4. cron 的优缺点

| 优点                    | 缺点                       |
| ----------------------- | -------------------------- |
| 简单易用、语法直观      | 日志不集中，排错困难       |
| 多数 Linux 系统默认自带 | 不支持任务依赖、失败重试   |
| 格式统一、轻量化        | 无法自动管理服务、资源约束 |

------

## 二、systemd timer：现代化的定时调度新选择

随着 systemd 在 Linux 生态的全面普及，**systemd-timer** 正逐渐成为 cron 的替代方案。
 它不仅能定时执行任务，还能依托 systemd 强大的服务管理、日志系统、依赖机制，实现更可靠的调度管理。

------

### 1. systemd timer 工作机制

systemd timer 由两个配置文件组成：

| 文件类型 | 作用                             |
| -------- | -------------------------------- |
| .service | 定义要执行的任务（脚本、命令）   |
| .timer   | 定义触发时间（类似 cron 表达式） |

------

### 2. 一个完整示例

#### 创建定时备份任务

📄 `/etc/systemd/system/db-backup.service`

```ini
[Unit]
Description=Database Backup Task

[Service]
Type=oneshot
ExecStart=/usr/local/bin/db_backup.sh
```

📄 `/etc/systemd/system/db-backup.timer`

```ini
[Unit]
Description=Run database backup every day at 03:00

[Timer]
OnCalendar=*-*-* 03:00
Persistent=true

[Install]
WantedBy=timers.target
```

执行启用：

```bash
systemctl daemon-reload
systemctl enable --now db-backup.timer
systemctl status db-backup.timer
```

------

### 3. systemd timer 时间表达式支持更强大

| 表达式                     | 含义                      |
| -------------------------- | ------------------------- |
| OnCalendar=*-*-* 03:00     | 每天凌晨 3 点             |
| OnCalendar=Mon *-*-* 09:00 | 每周一早上 9 点           |
| OnBootSec=10min            | 系统启动后第 10 分钟      |
| OnUnitInactiveSec=1h       | 上次执行 1 小时后再次执行 |

------

### 4. systemd-timer 的优势

| cron           | systemd timer              |
| -------------- | -------------------------- |
| 语法固定       | 支持自然语言式时间，灵活   |
| 无日志管理     | 日志集中查看 (journalctl)  |
| 不支持失败重试 | 可配置失败重试、任务依赖   |
| 业务脚本易失控 | 可配资源限制、CPU/内存约束 |
| 单一工具       | 深度支持 systemd 服务生态  |

------

### 5. 日志查看超方便！

```bash
journalctl -u db-backup.service --since "2025-01-01"
```

------

## 三、cron 与 systemd timer 该怎么选？

| 使用场景                          | 推荐工具                         |
| --------------------------------- | -------------------------------- |
| 简单脚本执行（清理日志/数据备份） | cron                             |
| 要控制日志、失败重试、任务依赖    | systemd timer                    |
| 云服务器、生产环境服务自动维护    | systemd timer                    |
| 临时调试、开发场景                | cron                             |
| 容器Docker环境                    | 大多数使用 cron 或第三方调度工具 |

------

## 四、如何让你的定时任务更稳定？

✔ 使用 `set -e` + 捕获异常
 ✔ 结合 `flock` 或 systemd 内部的 `Lockfile` 防止重复执行
 ✔ 输出日志并定期归档
 ✔ 加上通知功能（邮件/webhook/钉钉/企业微信）

------

## 五、总结

| 功能对比                   | cron       | systemd-timer |
| -------------------------- | ---------- | ------------- |
| 配置复杂度                 | 简单       | 较高          |
| 是否支持失败重试           | ❌          | ✔             |
| 日志集中管理               | ❌          | ✔             |
| 支持服务依赖关系           | ❌          | ✔             |
| 是否推荐在生产环境长期使用 | 🟡 基本可用 | 🟢 强烈推荐    |

**一句话总结：**

> cron 简单够用，但 systemd timer 更智能、更稳定、更适合生产环境。

如果你正在构建自动运维系统、服务器维护策略、容器编排或 DevOps 流水线 —— 那么，systemd timer 会成为你更强大的武器。