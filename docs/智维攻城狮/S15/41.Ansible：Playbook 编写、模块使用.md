# Ansible：Playbook 编写、模块使用

## 一、前言

在自动化运维领域，**Ansible** 以其无代理、轻量化和易扩展的特性，成为众多团队的首选工具。它的核心在于 **Playbook** 与 **模块**：前者定义自动化流程，后者提供具体执行能力。本文将从 Playbook 编写规范到常用模块使用，进行系统梳理。

------

## 二、Playbook 编写

### 1. 基本结构

Playbook 本质上是 **YAML 文件**，由以下部分组成：

- **hosts**：指定目标主机或主机组
- **tasks**：任务列表，每个任务调用一个模块
- **vars**：变量定义，支持层级覆盖
- **handlers**：触发式任务，常用于服务重启
- **roles**：结构化复用，便于团队协作

示例：

```yaml
- name: 部署 Nginx 服务
  hosts: webservers
  become: true
  vars:
    nginx_port: 80
  tasks:
    - name: 安装 Nginx
      yum:
        name: nginx
        state: present

    - name: 启动 Nginx
      service:
        name: nginx
        state: started
        enabled: true
```

### 2. 编写规范

- **命名清晰**：`name` 字段必须描述任务目的
- **模块参数对齐**：保持 YAML 缩进统一
- **变量集中化**：推荐使用 `group_vars` 与 `host_vars`
- **错误处理**：结合 `ignore_errors` 与 `failed_when`

------

## 三、模块使用

### 1. 常用模块分类

| 模块类别 | 常见模块                   | 功能说明                     |
| -------- | -------------------------- | ---------------------------- |
| 软件管理 | `yum`, `apt`               | 安装/卸载软件包              |
| 文件操作 | `copy`, `template`, `file` | 文件复制、模板渲染、权限管理 |
| 服务管理 | `service`, `systemd`       | 启停服务、开机自启           |
| 用户管理 | `user`, `group`            | 创建用户、分组管理           |
| 网络配置 | `firewalld`, `iptables`    | 防火墙规则配置               |
| 命令执行 | `command`, `shell`         | 执行命令或脚本               |

### 2. 模块示例

- **文件复制**

```yaml
- name: 分发配置文件
  copy:
    src: ./nginx.conf
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: '0644'
```

- **模板渲染**

```yaml
- name: 渲染配置模板
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
```

- **服务管理**

```yaml
- name: 重启 Nginx
  service:
    name: nginx
    state: restarted
```

------

## 四、最佳实践清单

- ✅ 使用 **roles** 分层管理，避免 Playbook 冗长
- ✅ 将敏感信息放入 **Vault** 加密
- ✅ 在 CI/CD 中集成 `ansible-lint` 做语法检查
- ✅ 结合 **tags** 精准执行部分任务
- ✅ 善用 **handlers**，避免重复重启服务

------

## 五、结语

Ansible 的优势在于 **声明式配置** 与 **模块化执行**。掌握 Playbook 编写规范与常用模块，能让运维自动化更高效、更可控。随着项目复杂度提升，进一步探索 **roles**、**Galaxy** 与 **动态 inventory**，将是进阶之路。

