import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,a as n,o as e}from"./app-BiQR_lPj.js";const l={};function t(h,s){return e(),a("div",null,s[0]||(s[0]=[n(`<h1 id="nginx如何获取客户端的真实ip" tabindex="-1"><a class="header-anchor" href="#nginx如何获取客户端的真实ip"><span>Nginx如何获取客户端的真实IP？</span></a></h1><h1 id="nginx获取客户端真实ip完全指南-从原理到实战配置" tabindex="-1"><a class="header-anchor" href="#nginx获取客户端真实ip完全指南-从原理到实战配置"><span>Nginx获取客户端真实IP完全指南：从原理到实战配置</span></a></h1><h2 id="引言" tabindex="-1"><a class="header-anchor" href="#引言"><span>引言</span></a></h2><p>在现代互联网架构中，<strong>反向代理技术</strong>已成为提升网站性能与可靠性的核心组件。作为全球最流行的 Web 服务器之一，Nginx 以其高性能、低资源占用及灵活性著称，目前已被部署在超过 3 亿个网站上。这种普及性源于其作为反向代理服务器的卓越表现——能够有效分发流量、缓存静态资源并增强后端服务安全性[<a href="http://blog.wya1.com/article/2068800324/details/37229" target="_blank" rel="noopener noreferrer">1</a>]。</p><p>然而，反向代理的广泛应用也带来了<strong>客户端真实 IP 获取的挑战</strong>。当 Nginx 或 CDN 服务作为中间层时，服务器日志通常记录的是代理节点 IP 而非原始请求来源。例如，某网站接入 Cloudflare CDN 后，所有访问日志均显示为 Cloudflare 的节点 IP，导致无法直接追溯真实用户地址；同时 Cloudflare 控制台仅支持查看 24 小时内的访问记录，难以满足批量日志分析需求[<a href="https://blog.csdn.net/zhuannnn/article/details/145565782" target="_blank" rel="noopener noreferrer">2</a>]。这种信息缺失直接影响日志审计、访问控制策略制定及安全事件溯源的准确性。</p><p><strong>核心需求</strong>：准确获取客户端真实 IP 是实现精细化运维的基础——无论是用户行为分析、异常流量监控，还是基于 IP 的访问限制与合规审计，均依赖这一关键数据。在多代理架构下，如何穿透层层转发还原真实地址，已成为运维与开发人员的必备技能。</p><p>本文将构建一套<strong>从原理到实战的完整解决方案</strong>，系统讲解 Nginx 反向代理场景下 IP 传递的底层机制，提供跨场景配置指南（含 CDN、多级代理等复杂环境），并结合实战案例与安全最佳实践，帮助技术人员彻底解决真实 IP 获取难题。</p><h2 id="nginx反向代理下的ip问题原理" tabindex="-1"><a class="header-anchor" href="#nginx反向代理下的ip问题原理"><span>Nginx反向代理下的IP问题原理</span></a></h2><h3 id="反向代理如何隐藏客户端ip" tabindex="-1"><a class="header-anchor" href="#反向代理如何隐藏客户端ip"><span>反向代理如何隐藏客户端IP</span></a></h3><p>反向代理作为客户端与后端服务器之间的中间节点，其核心转发机制会导致后端服务器无法直接获取客户端真实IP。从网络通信原理来看，这种隐藏效应源于代理服务器在<strong>传输层</strong>和<strong>应用层</strong>的双重处理机制。</p><p>在<strong>传输层（TCP/IP协议栈）</strong>，客户端发起的请求首先与反向代理服务器建立TCP连接，代理服务器再以自身名义与后端服务器建立新的TCP连接。这种<strong>连接重建过程</strong>使得后端服务器的TCP连接对象始终是代理服务器，因此从IP报文头部的<code>src</code>字段中只能解析出代理服务器的IP。此外，代理服务器通常会执行<strong>网络地址转换（NAT）</strong>，主动替换IP报文的源地址字段，进一步强化对客户端IP的隐藏效果[<a href="https://docs.fortinet.com/document/fortiweb/7.0.2/cli-reference/577849/waf-x-forwarded-for" target="_blank" rel="noopener noreferrer">6</a>]。</p><p>在<strong>应用层（HTTP协议）</strong>，代理服务器转发请求时默认不会主动传递客户端IP信息。后端服务器通过<code>remote_addr</code>等标准字段获取的IP地址，本质上是TCP连接的对端IP（即代理服务器IP）。例如，未配置特殊模块时，Nginx的<code>access_log</code>日志和PHP的<code>$_SERVER[&#39;REMOTE_ADDR&#39;]</code>变量均会记录反向代理的IP[<a href="https://blog.csdn.net/weixin_34006965/article/details/91794862" target="_blank" rel="noopener noreferrer">7</a>]。</p><p><strong>无代理与有代理场景的IP记录差异</strong></p><ul><li><strong>无代理场景</strong>：客户端直接与后端服务器建立TCP连接，<code>remote_addr</code>字段直接反映真实客户端IP（如<code>100.100.100.1</code>）。</li><li><strong>有代理场景</strong>：代理服务器作为中间人重建连接，后端服务器的<code>remote_addr</code>、日志记录及应用层变量均显示代理IP（如CDN节点IP <code>192.168.1.100</code>）。</li></ul><h3 id="x-forwarded-for与x-real-ip的作用与区别" tabindex="-1"><a class="header-anchor" href="#x-forwarded-for与x-real-ip的作用与区别"><span>X-Forwarded-For与X-Real-IP的作用与区别</span></a></h3><p>X-Forwarded-For（XFF）和X-Real-IP均为HTTP请求头字段，用于代理服务器向后端服务器传递客户端真实IP地址。两者在格式、信息完整性及适用场景上存在显著差异。</p><h4 id="一、核心差异对比" tabindex="-1"><a class="header-anchor" href="#一、核心差异对比"><span>一、核心差异对比</span></a></h4><table><thead><tr><th><strong>维度</strong></th><th><strong>X-Forwarded-For</strong></th><th><strong>X-Real-IP</strong></th></tr></thead><tbody><tr><td><strong>格式</strong></td><td>逗号分隔的IP列表，格式为<code>客户端IP, 代理1IP, 代理2IP...</code></td><td>单个IP地址，格式为<code>客户端IP</code>或<code>直接连接的代理IP</code></td></tr><tr><td><strong>包含信息</strong></td><td>记录完整代理链，第一个IP为原始客户端真实IP，后续为各级代理服务器IP</td><td>仅包含单个IP，通常为最靠近源站的上一级代理IP（默认行为）</td></tr><tr><td><strong>适用场景</strong></td><td>多级代理架构，需追溯完整请求路径（如CDN+负载均衡+应用服务器）</td><td>单级代理或简单架构，仅需传递最终客户端IP</td></tr><tr><td><strong>安全性</strong></td><td>可被客户端伪造（需通过<code>set_real_ip_from</code>等配置限定信任代理IP段）[<a href="https://github.com/sozu-proxy/sozu/issues/1113" target="_blank" rel="noopener noreferrer">14</a>]</td><td>依赖代理配置，若第一层代理正确设置客户端IP且后续代理透传，则安全性较高</td></tr></tbody></table><h4 id="二、实例解析-两级代理场景下的表现" tabindex="-1"><a class="header-anchor" href="#二、实例解析-两级代理场景下的表现"><span>二、实例解析：两级代理场景下的表现</span></a></h4><p>当请求经过<strong>客户端 → 代理1 → 代理2 → 源站</strong>的两级代理链路时：</p><ul><li><strong>X-Forwarded-For</strong>：值为<code>203.0.113.1, 198.51.100.1, 172.16.0.1</code>（客户端IP, 代理1IP, 代理2IP）</li><li><strong>X-Real-IP</strong>：值为<code>172.16.0.1</code>（仅代理2IP，默认行为）</li></ul><p><strong>关键结论</strong>：无论选择哪种头字段，核心是通过<strong>信任链设计</strong>（限定可信代理IP）和<strong>代理配置一致性</strong>确保IP传递的真实性。X-Forwarded-For提供完整路径但需严格校验，X-Real-IP简化传递但依赖代理规范执行。</p><h2 id="ngx-http-realip-module模块详解" tabindex="-1"><a class="header-anchor" href="#ngx-http-realip-module模块详解"><span>ngx_http_realip_module模块详解</span></a></h2><h3 id="模块作用与编译安装" tabindex="-1"><a class="header-anchor" href="#模块作用与编译安装"><span>模块作用与编译安装</span></a></h3><p>在反向代理或多级代理架构中，Nginx 默认通过 <code>$remote_addr</code> 变量记录直接连接方的 IP 地址，这导致该变量在代理场景下会被替换为<strong>代理服务器的 IP</strong>，而非真实客户端 IP。ngx_http_realip_module 模块的核心功能是<strong>从信任的代理服务器传递的 HTTP 请求头中提取真实客户端 IP，并覆盖 <code>$remote_addr</code> 变量的值</strong>。</p><h4 id="编译安装步骤" tabindex="-1"><a class="header-anchor" href="#编译安装步骤"><span>编译安装步骤</span></a></h4><p>ngx_http_realip_module 模块<strong>默认不随 Nginx 编译安装</strong>，需通过源码编译时手动指定启用：</p><ol><li><p><strong>下载源码</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">wget</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> http://nginx.org/download/nginx-1.26.0.tar.gz</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p><strong>解压并配置编译参数</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tar</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -zxvf</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> nginx-1.26.0.tar.gz</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">cd</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> nginx-1.26.0/</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">./configure</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --prefix=/usr/local/nginx</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  --with-http_ssl_module</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \\</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  --with-http_realip_module</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 启用realip模块</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>编译与安装</strong></p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &amp;&amp; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><h4 id="验证安装" tabindex="-1"><a class="header-anchor" href="#验证安装"><span>验证安装</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">/usr/local/nginx/sbin/nginx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -V</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> 2&gt;&amp;1 | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">grep</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;realip&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>若输出包含 <code>--with-http_realip_module</code>，则表示模块已启用。</p><h3 id="核心指令解析" tabindex="-1"><a class="header-anchor" href="#核心指令解析"><span>核心指令解析</span></a></h3><h4 id="set-real-ip-from" tabindex="-1"><a class="header-anchor" href="#set-real-ip-from"><span>set_real_ip_from</span></a></h4><p><strong>作用</strong>：定义可信代理服务器的IP地址或网段，仅来自这些来源的请求才会触发真实IP重写逻辑。<br><strong>语法</strong>：<code>set_real_ip_from &lt;address | CIDR | unix&gt;</code><br><strong>示例</strong>：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-nginx"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">set_real_ip_from </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10.0.0.5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;          </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 单个代理IP</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">set_real_ip_from </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">192.168.1.0/24;     </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># IP网段</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">set_real_ip_from </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">2001:0db8::/32;     </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># IPv6网段</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="real-ip-header" tabindex="-1"><a class="header-anchor" href="#real-ip-header"><span>real_ip_header</span></a></h4><p><strong>作用</strong>：指定从哪个HTTP请求头提取客户端真实IP。<br><strong>语法</strong>：<code>real_ip_header &lt;field | X-Real-IP | X-Forwarded-For&gt;</code><br><strong>示例</strong>：</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-nginx"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">real_ip_header </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">X-Forwarded-For;      </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 从XFF头提取IP链</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">real_ip_header </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">CF-Connecting-IP;     </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Cloudflare专用头</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="real-ip-recursive" tabindex="-1"><a class="header-anchor" href="#real-ip-recursive"><span>real_ip_recursive</span></a></h4><p><strong>作用</strong>：控制是否递归排除信任代理IP，解决多级代理场景下的IP识别问题。<br><strong>语法</strong>：<code>real_ip_recursive on | off</code></p><p><strong>关键逻辑对比</strong>：假设<code>X-Forwarded-For: 103.21.244.1（客户端）, 10.0.0.5（代理1）, 10.0.0.7（代理2）</code>，且已信任10.0.0.5和10.0.0.7：</p><ul><li><code>real_ip_recursive off</code> → 取最后一个IP（10.0.0.7，错误）</li><li><code>real_ip_recursive on</code> → 排除信任IP，取103.21.244.1（正确）</li></ul><h3 id="内置变量与应用场景" tabindex="-1"><a class="header-anchor" href="#内置变量与应用场景"><span>内置变量与应用场景</span></a></h3><h4 id="核心变量对比" tabindex="-1"><a class="header-anchor" href="#核心变量对比"><span>核心变量对比</span></a></h4><table><thead><tr><th><strong>变量</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><code>$remote_addr</code></td><td>处理后的客户端真实IP（经realip模块转换）</td></tr><tr><td><code>$realip_remote_addr</code></td><td>保留原始客户端地址（不受realip模块影响，Nginx 1.9.7+支持）</td></tr></tbody></table><h4 id="典型应用场景" tabindex="-1"><a class="header-anchor" href="#典型应用场景"><span>典型应用场景</span></a></h4><p><strong>1. 日志记录原始IP</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-nginx"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">log_format </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">combined_realip </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;$</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">remote_addr</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> [$</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">time_local</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">] &quot;$</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">request</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot; &#39;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                          &#39;$</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">status</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> $</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">body_bytes_sent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;$</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">http_referer</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot; &#39;</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">                          &#39;&quot;$</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">http_user_agent</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot; &quot;$</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">realip_remote_addr</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">access_log </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">/var/log/nginx/access.log combined_realip;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2. IP白名单访问控制</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-nginx"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">location</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> /sensitive-api {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    allow </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">192.168.1.0/24;  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 仅允许特定IP访问</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    deny </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">all</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    proxy_pass </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">http://backend_server;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="配置实战-从单级代理到cdn环境" tabindex="-1"><a class="header-anchor" href="#配置实战-从单级代理到cdn环境"><span>配置实战：从单级代理到CDN环境</span></a></h2><h3 id="单级代理配置" tabindex="-1"><a class="header-anchor" href="#单级代理配置"><span>单级代理配置</span></a></h3><h4 id="拓扑说明" tabindex="-1"><a class="header-anchor" href="#拓扑说明"><span>拓扑说明</span></a></h4><p><strong>客户端 → 代理服务器 → 后端Nginx</strong>，需配置代理服务器传递IP头，后端Nginx信任代理IP并提取真实IP。</p><h4 id="配置代码" tabindex="-1"><a class="header-anchor" href="#配置代码"><span>配置代码</span></a></h4><p><strong>1. 代理服务器配置</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-nginx"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">server</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    listen </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">80</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    location</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> / {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        proxy_pass </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">http://后端NginxIP:端口;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        proxy_set_header </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Host $</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">http_host</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        proxy_set_header </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">X-Forwarded-For $</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">proxy_add_x_forwarded_for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 传递IP链</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        proxy_set_header </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">X-Real-IP $</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">remote_addr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 传递客户端IP</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2. 后端Nginx配置</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-nginx"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">server</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    listen </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">80</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # 声明可信代理IP</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    set_real_ip_from </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">192.168.1.0/24;  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 代理服务器IP段</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    real_ip_header </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">X-Forwarded-For;   </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 从XFF头提取IP链</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    real_ip_recursive </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">on</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;             </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 启用递归排除</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    location</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> / {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        proxy_pass </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">http://backend_server;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="多级代理配置" tabindex="-1"><a class="header-anchor" href="#多级代理配置"><span>多级代理配置</span></a></h3><h4 id="配置要点" tabindex="-1"><a class="header-anchor" href="#配置要点"><span>配置要点</span></a></h4><p>多级代理需确保每级代理正确传递<code>X-Forwarded-For</code>头，后端服务器声明所有上游代理IP为可信，并启用递归解析。</p><h4 id="分步配置" tabindex="-1"><a class="header-anchor" href="#分步配置"><span>分步配置</span></a></h4><p><strong>1. 上游代理配置</strong>（每级代理均需添加）</p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-nginx"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">proxy_set_header </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">X-Forwarded-For $</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">proxy_add_x_forwarded_for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>2. 后端服务器配置</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-nginx"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">server</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    listen </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">80</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # 信任所有上游代理IP</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    set_real_ip_from </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10.0.0.5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 代理1</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    set_real_ip_from </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10.0.0.6</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 代理2</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    set_real_ip_from </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10.0.0.7</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 代理3</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    real_ip_header </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">X-Forwarded-For;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    real_ip_recursive </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">on</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 递归排除可信IP</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="cdn环境特殊配置" tabindex="-1"><a class="header-anchor" href="#cdn环境特殊配置"><span>CDN环境特殊配置</span></a></h3><h4 id="cloudflare-cdn配置" tabindex="-1"><a class="header-anchor" href="#cloudflare-cdn配置"><span>Cloudflare CDN配置</span></a></h4><ol><li><p><strong>获取官方IP段</strong><br> IPv4: <code>https://www.cloudflare.com/ips-v4</code><br> IPv6: <code>https://www.cloudflare.com/ips-v6</code></p></li><li><p><strong>Nginx配置示例</strong></p><div class="language-nginx line-numbers-mode" data-highlighter="shiki" data-ext="nginx" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-nginx"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 引入Cloudflare IP段配置</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">include </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">/etc/nginx/cloudflare-ips.conf;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">real_ip_header </span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">CF-Connecting-IP;  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 使用Cloudflare专用头</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h4 id="自动化ip段更新脚本" tabindex="-1"><a class="header-anchor" href="#自动化ip段更新脚本"><span>自动化IP段更新脚本</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 下载并生成Cloudflare IP段配置</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">curl</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> https://www.cloudflare.com/ips-v4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">awk</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;{print &quot;set_real_ip_from &quot; $0 &quot;;&quot;}&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/etc/nginx/cloudflare-ips.conf</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nginx</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &amp;&amp; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> reload</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> nginx</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 验证并重载Nginx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="安全最佳实践" tabindex="-1"><a class="header-anchor" href="#安全最佳实践"><span>安全最佳实践</span></a></h2><h3 id="信任ip的精细化配置" tabindex="-1"><a class="header-anchor" href="#信任ip的精细化配置"><span>信任IP的精细化配置</span></a></h3><h4 id="配置原则" tabindex="-1"><a class="header-anchor" href="#配置原则"><span>配置原则</span></a></h4><p>遵循<strong>最小权限原则</strong>，仅将直接对接的代理服务器IP或IP段加入信任列表，支持格式：</p><ul><li>单个IP：<code>set_real_ip_from 192.168.2.1;</code></li><li>CIDR网段：<code>set_real_ip_from 203.0.113.0/24;</code></li></ul><h4 id="风险对比" tabindex="-1"><a class="header-anchor" href="#风险对比"><span>风险对比</span></a></h4><table><thead><tr><th>配置类型</th><th>示例</th><th>风险等级</th><th>适用场景</th></tr></thead><tbody><tr><td>精确IP段</td><td><code>set_real_ip_from 4.4.4.4/24</code></td><td>低</td><td>已知代理服务器集群</td></tr><tr><td>通配符网段</td><td><code>set_real_ip_from 0.0.0.0/0</code></td><td>极高</td><td>无（任何场景均禁止）</td></tr></tbody></table><p><strong>关键安全实践</strong></p><ol><li>定期更新信任IP列表：CDN或云服务商IP段可能变更，需通过自动化工具同步官方IP列表[<a href="https://www.getpagespeed.com/server-setup/nginx/cloudflare-and-nginx-automatic-sync-of-cloudflare-trusted-ip-addresses/amp" target="_blank" rel="noopener noreferrer">18</a>]。</li><li>禁止源站直接暴露：通过配置默认站点返回444错误，阻止攻击者绕过代理直接访问源站IP[<a href="https://blog.csdn.net/qq_73617452/article/details/147594026" target="_blank" rel="noopener noreferrer">25</a>]。</li></ol><h2 id="常见问题排查" tabindex="-1"><a class="header-anchor" href="#常见问题排查"><span>常见问题排查</span></a></h2><h3 id="配置不生效的核心原因" tabindex="-1"><a class="header-anchor" href="#配置不生效的核心原因"><span>配置不生效的核心原因</span></a></h3><h4 id="模块未启用" tabindex="-1"><a class="header-anchor" href="#模块未启用"><span>模块未启用</span></a></h4><p><strong>现象</strong>：启动时报<code>unknown directive &quot;set_real_ip_from&quot;</code><br><strong>验证</strong>：<code>nginx -V | grep realip</code>，确认输出包含<code>--with-http_realip_module</code></p><h4 id="信任ip配置不完整" tabindex="-1"><a class="header-anchor" href="#信任ip配置不完整"><span>信任IP配置不完整</span></a></h4><p><strong>现象</strong>：获取的IP为代理IP而非客户端真实IP<br><strong>验证</strong>：对比<code>set_real_ip_from</code>配置与实际代理IP，确保包含所有上游代理IP段</p><h4 id="real-ip-recursive设置不当" tabindex="-1"><a class="header-anchor" href="#real-ip-recursive设置不当"><span>real_ip_recursive设置不当</span></a></h4><p><strong>现象</strong>：多级代理场景下IP提取错误<br><strong>建议</strong>：多级代理必须设置<code>real_ip_recursive on</code>，单级代理可设为<code>off</code></p><h3 id="排查工具与命令" tabindex="-1"><a class="header-anchor" href="#排查工具与命令"><span>排查工具与命令</span></a></h3><ul><li><strong>验证配置语法</strong>：<code>nginx -t</code></li><li><strong>实时监控日志</strong>：<code>tail -f /var/log/nginx/access.log</code></li><li><strong>临时响应头调试</strong>：<code>add_header X-Real-IP $realip_remote_addr;</code></li></ul><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>本文系统讲解了Nginx获取客户端真实IP的完整解决方案，核心配置逻辑可凝练为<strong>信任IP界定、HTTP头传递与递归参数配置</strong>三大要素。不同网络架构下的配置策略差异显著：单层级代理需重点关注信任IP与HTTP头匹配；多层级代理或CDN环境则需启用递归解析并验证全链路头传递的完整性。</p><p><strong>建议</strong>：在实际部署中，应优先通过架构梳理明确代理层级与厂商特性，选择符合RFC标准的<code>X-Forwarded-For</code>头作为主流方案，同时辅以<code>real_ip_recursive on</code>确保递归解析。配置完成后需通过日志审计和模拟请求测试验证有效性，并建立季度周期的配置审查机制。</p>`,94)]))}const p=i(l,[["render",t]]),k=JSON.parse('{"path":"/%E6%99%BA%E7%BB%B4%E6%94%BB%E5%9F%8E%E7%8B%AE/S15/4.Nginx%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E7%9C%9F%E5%AE%9EIP%EF%BC%9F.html","title":"Nginx如何获取客户端的真实IP？","lang":"en-US","frontmatter":{},"git":{"createdTime":1756914694000,"updatedTime":1756914694000,"contributors":[{"name":"star","username":"star","email":"star@xgss.net","commits":1,"url":"https://github.com/star"}]},"readingTime":{"minutes":9.95,"words":2984},"filePathRelative":"智维攻城狮/S15/4.Nginx如何获取客户端的真实IP？.md"}');export{p as comp,k as data};
