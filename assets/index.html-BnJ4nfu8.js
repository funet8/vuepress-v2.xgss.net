import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as i,a as e,o as n}from"./app-BiQR_lPj.js";const l={};function d(r,s){return n(),i("div",null,s[0]||(s[0]=[e(`<h1 id="linux服务器故障排查基本方案" tabindex="-1"><a class="header-anchor" href="#linux服务器故障排查基本方案"><span>Linux服务器故障排查基本方案</span></a></h1><h1 id="服务器架构" tabindex="-1"><a class="header-anchor" href="#服务器架构"><span>服务器架构</span></a></h1><p>服务器系统为Centos7</p><p>首先需要知晓系统的对外的架构</p><p>一般架构：</p><p>1.域名---&gt;云服务器（ECS）</p><p>2.域名---&gt;CDN---&gt;云服务器（OSS）</p><p>3.域名---&gt;CDN---&gt;云服务器ECS+数据库RDS+缓存Redis</p><p>4.域名---&gt;CDN---&gt;负载均衡---&gt;云服务器ECS+数据库RDS(主从)+缓存Redis</p><p>5.域名---&gt;CDN--&gt;WAF防火墙---&gt;负载均衡---&gt;云服务器ECS+数据库RDS(主从)+缓存Redis</p><p>再根据实际情况出现的问题，一步步排查。</p><p><img src="https://imgoss.xgss.net/picgo/Linux-fwuqi-chakanliuchangsss.jpg?aliyun" alt="Linux-fwuqi-chakanliuchangsss"></p><h1 id="发现问题" tabindex="-1"><a class="header-anchor" href="#发现问题"><span>发现问题</span></a></h1><h1 id="一、发现问题" tabindex="-1"><a class="header-anchor" href="#一、发现问题"><span>一、发现问题</span></a></h1><p>首先发现问题，及时确定哪个服务出现问题，以便方便快速定位问题。查找对应的域名和设备</p><h2 id="zabbix监控发钉钉告警" tabindex="-1"><a class="header-anchor" href="#zabbix监控发钉钉告警"><span>Zabbix监控发钉钉告警</span></a></h2><p><img src="https://imgoss.xgss.net/picgo/1614243525084-f79b25e3-c800-40c4-bb82-6945b2340386.png?aliyun" alt="img"></p><h3 id="阿里云监控告警短信" tabindex="-1"><a class="header-anchor" href="#阿里云监控告警短信"><span>阿里云监控告警短信</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>【阿里云】尊敬的***,云监控-云数据库RDS版&lt;华南1(深圳)-*****-只读&gt;于&lt;09:54&gt;发生报警，CPU使用率（91.88&gt;=80），持续时间4分钟</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_3-shell脚本邮件告警" tabindex="-1"><a class="header-anchor" href="#_3-shell脚本邮件告警"><span>3.shell脚本邮件告警</span></a></h3><p><img src="https://imgoss.xgss.net/picgo/1614243666883-c830f798-fbbd-413f-bdd4-d26a9333c56f.png?aliyun" alt="img"></p><h3 id="_4-其他同事" tabindex="-1"><a class="header-anchor" href="#_4-其他同事"><span>4.其他同事</span></a></h3><p>客服、市场同事等钉钉、电话报告出现的问题</p><h2 id="二、快速定位问题" tabindex="-1"><a class="header-anchor" href="#二、快速定位问题"><span>二、快速定位问题</span></a></h2><h3 id="网络带宽-cdn是否异常" tabindex="-1"><a class="header-anchor" href="#网络带宽-cdn是否异常"><span>网络带宽（CDN是否异常）</span></a></h3><p>域名是否解析到源站</p><p>登录阿里云CDN后台查看相应流量</p><h3 id="负载均衡" tabindex="-1"><a class="header-anchor" href="#负载均衡"><span>负载均衡</span></a></h3><p>检查负载均衡是否正常运行，是否流量异常</p><h3 id="应用层服务器" tabindex="-1"><a class="header-anchor" href="#应用层服务器"><span>应用层服务器</span></a></h3><p>ECS服务器负载是否正常、cpu、内存负载是否过高，硬盘使用率是否达到100%等</p><h3 id="缓存服务器" tabindex="-1"><a class="header-anchor" href="#缓存服务器"><span>缓存服务器</span></a></h3><p>redis服务器负载是否正常、内存使用率如何</p><h3 id="数据库服务器" tabindex="-1"><a class="header-anchor" href="#数据库服务器"><span>数据库服务器</span></a></h3><p>数据库连接数是否正常</p><p>列出当前用户的所有连接信息；</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>show full processlist;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>杀进程，时长消耗太长的sql进程</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>select concat(&#39;kill &#39;, id, &#39;;&#39;) from information_schema.processlist where command != &#39;Sleep&#39; and time &gt; 2*60 order by time desc;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>让将sql语句发给后端研发分析</p><h2 id="远程连接服务器" tabindex="-1"><a class="header-anchor" href="#远程连接服务器"><span>远程连接服务器</span></a></h2><h1 id="问题-cpu高-负载高-访问慢-数据库正常" tabindex="-1"><a class="header-anchor" href="#问题-cpu高-负载高-访问慢-数据库正常"><span>问题：CPU高，负载高，访问慢（数据库正常）</span></a></h1><h2 id="系统层面" tabindex="-1"><a class="header-anchor" href="#系统层面"><span>系统层面</span></a></h2><h3 id="查看负载" tabindex="-1"><a class="header-anchor" href="#查看负载"><span>查看负载</span></a></h3><p>查看负载、CPU、内存、上线时间、高资源进程</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># top</span></span>
<span class="line"><span>安装： yum -y install htop</span></span>
<span class="line"><span># htop</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看top服务器负载，内存消耗，df -h查看硬盘</p><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-plain"><span class="line"><span>top</span></span>
<span class="line"><span>df</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://imgoss.xgss.net/picgo/1614243765194-e9717edb-39a8-410c-88e2-d8f1b3b2906f.png?aliyun" alt="img"></p><h3 id="查看nginx日志" tabindex="-1"><a class="header-anchor" href="#查看nginx日志"><span>查看nginx日志</span></a></h3><p>如果有nginx日志，进入nginx日志目录</p><p>按照日志大小排列</p><p>判断日志访问、相应时长，url等</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>cd /data/wwwroot/log</span></span>
<span class="line"><span>ll -Srh</span></span>
<span class="line"><span>tail -f XXX.XXX.COM-access.log</span></span>
<span class="line"><span>分析日志，找出最多的IP日志、最多的URL等</span></span>
<span class="line"><span>GoAccess 、ELK后台查看日志</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查看磁盘使用情况" tabindex="-1"><a class="header-anchor" href="#查看磁盘使用情况"><span>查看磁盘使用情况</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>df -h</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="查看磁盘当前情况" tabindex="-1"><a class="header-anchor" href="#查看磁盘当前情况"><span>查看磁盘当前情况</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>iostat -x -k 3 3</span></span>
<span class="line"><span>avg-cpu:  %user   %nice %system %iowait  %steal   %idle</span></span>
<span class="line"><span>           3.70    0.00    2.25    0.41    0.00   93.64</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span></span>
<span class="line"><span>vda               0.01     0.83    0.30    1.48    11.34    12.13    26.30     0.01    6.15    7.41    5.89   0.24   0.04</span></span>
<span class="line"><span>vdb               0.00     0.17    0.02    0.28     0.08     2.75    19.15     0.00    3.22    2.01    3.29   0.26   0.01</span></span>
<span class="line"><span>vdc               0.10     0.84    3.09    0.56   105.22    20.57    68.94     0.02    7.96    3.29   33.74   1.33   0.49</span></span>
<span class="line"><span></span></span>
<span class="line"><span>如果发现当前磁盘忙碌，则查看是哪个 PID 在忙碌：</span></span>
<span class="line"><span>安装 yum install -y iotop</span></span>
<span class="line"><span># iotop -o -P -k -d 5</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查看对外服务和端口" tabindex="-1"><a class="header-anchor" href="#查看对外服务和端口"><span>查看对外服务和端口</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># netstat -tunpl</span></span>
<span class="line"><span>Active Internet connections (only servers)</span></span>
<span class="line"><span>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span></span>
<span class="line"><span>tcp        0      0 0.0.0.0:62920           0.0.0.0:*               LISTEN      29177/vsftpd        </span></span>
<span class="line"><span>tcp        0      0 0.0.0.0:8080            0.0.0.0:*               LISTEN      4393/httpd      </span></span>
<span class="line"><span>tcp        0      0 0.0.0.0:7300            0.0.0.0:*               LISTEN      4697/php-fpm: maste</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查看-pid-具体在" tabindex="-1"><a class="header-anchor" href="#查看-pid-具体在"><span>查看 PID 具体在</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>安装  yum install lsof</span></span>
<span class="line"><span></span></span>
<span class="line"><span>lsof -p PID</span></span>
<span class="line"><span>lsof -p 29177</span></span>
<span class="line"><span>lsof -p 4697</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查看系统日志" tabindex="-1"><a class="header-anchor" href="#查看系统日志"><span>查看系统日志</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>tail -400f /var/log/messages</span></span>
<span class="line"><span>tail -f /var/log/messages</span></span>
<span class="line"><span>tail -n100 /var/log/messages</span></span>
<span class="line"><span>head -n100 /var/log/messages</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查看简化线程树" tabindex="-1"><a class="header-anchor" href="#查看简化线程树"><span>查看简化线程树</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>pstree -a &gt;&gt; /root/pstree.log</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="网络问题" tabindex="-1"><a class="header-anchor" href="#网络问题"><span>网络问题</span></a></h2><h3 id="ping域名" tabindex="-1"><a class="header-anchor" href="#ping域名"><span>ping域名</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>ping www.XXX.com</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="查看网络节点情况" tabindex="-1"><a class="header-anchor" href="#查看网络节点情况"><span>查看网络节点情况</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>安装： yum install -y  traceroute</span></span>
<span class="line"><span></span></span>
<span class="line"><span>traceroute www.baidu.com</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="问题-cpu-低-负载高-访问慢-数据库" tabindex="-1"><a class="header-anchor" href="#问题-cpu-低-负载高-访问慢-数据库"><span>问题：CPU 低，负载高，访问慢（数据库）</span></a></h1><h2 id="判断的数据库" tabindex="-1"><a class="header-anchor" href="#判断的数据库"><span>判断的数据库</span></a></h2><h3 id="_1-慢查询" tabindex="-1"><a class="header-anchor" href="#_1-慢查询"><span>1.慢查询</span></a></h3><p>检查慢查询日志，可能是慢查询引起负载高，根据配置文件查看存放位置：log_slow_queries</p><h3 id="_2-是否有系统瓶颈" tabindex="-1"><a class="header-anchor" href="#_2-是否有系统瓶颈"><span>2.是否有系统瓶颈</span></a></h3><p>升级系统cpu、内存、硬盘，</p><p>优化架构增加主从，一主多从等。</p><h3 id="_3-sleep连接是否过多" tabindex="-1"><a class="header-anchor" href="#_3-sleep连接是否过多"><span>3.sleep连接是否过多</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>show full processlist;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_4-查看最大连接数" tabindex="-1"><a class="header-anchor" href="#_4-查看最大连接数"><span>4.查看最大连接数</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>查看设置的最大连接数</span></span>
<span class="line"><span>show variables like &#39;max_connections&#39;;</span></span>
<span class="line"><span>重新设置最大连接数</span></span>
<span class="line"><span>set GLOBAL max_connections=300</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="nginx防护基本命令" tabindex="-1"><a class="header-anchor" href="#nginx防护基本命令"><span>Nginx防护基本命令</span></a></h1><p>如果有一些异常访问，可以加入配合阿里云的WAF。</p><h3 id="访问最多真实用户的ip" tabindex="-1"><a class="header-anchor" href="#访问最多真实用户的ip"><span>访问最多真实用户的IP</span></a></h3><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-plain"><span class="line"><span>cat www.XXXX.com-access.log |awk &#39;{print $5}&#39;| awk -F&quot;:&quot; &#39;{print $NF}&#39; |sort|uniq -c|sort -nr|head -10</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="查看访问排行前10的url" tabindex="-1"><a class="header-anchor" href="#查看访问排行前10的url"><span>查看访问排行前10的url</span></a></h3><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-plain"><span class="line"><span>cat  www.XXX.com-access.log | awk &#39;{print $10}&#39; | sort | uniq -c | sort -nr | head -n 10</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="执行时间最长10条" tabindex="-1"><a class="header-anchor" href="#执行时间最长10条"><span>执行时间最长10条</span></a></h3><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-plain"><span class="line"><span>cat  www.XXX.com-access.log | sort -nr | head -n 10</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="查看http-referer来路" tabindex="-1"><a class="header-anchor" href="#查看http-referer来路"><span>查看http_referer来路：</span></a></h3><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-plain"><span class="line"><span>cat www.XXX.com-access.log | awk -F&quot;from:&quot; &#39;{print $NF}&#39; |sort|uniq -c|sort -nr|head -10</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>封IP，查看特定的referer来源地址</p><h3 id="服务器防火墙封ip" tabindex="-1"><a class="header-anchor" href="#服务器防火墙封ip"><span>服务器防火墙封ip</span></a></h3><p>封IP段</p><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-plain"><span class="line"><span>/sbin/iptables -I INPUT -s 61.37.80.0/24 -j DROP</span></span>
<span class="line"><span>#屏蔽单个IP的命令是</span></span>
<span class="line"><span> deny 123.45.6.7</span></span>
<span class="line"><span> #封整个段即从123.0.0.1到123.255.255.254的命令</span></span>
<span class="line"><span> deny 123.0.0.0/8</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="禁止特定用户代理-user-agents-访问" tabindex="-1"><a class="header-anchor" href="#禁止特定用户代理-user-agents-访问"><span>禁止特定用户代理（User Agents）访问</span></a></h3><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-plain"><span class="line"><span>if ($http_user_agent ~* (wget|curl|Firefox) ) {</span></span>
<span class="line"><span>return 404;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="特定的地址攻击做跳转" tabindex="-1"><a class="header-anchor" href="#特定的地址攻击做跳转"><span>特定的地址攻击做跳转</span></a></h3><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-plain"><span class="line"><span>rewrite ^/accounts/\\+\\$str\\+ http://127.0.0.1/ redirect;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="根据-user-agent-控制客户端访问" tabindex="-1"><a class="header-anchor" href="#根据-user-agent-控制客户端访问"><span>根据 user_agent 控制客户端访问</span></a></h3><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-plain"><span class="line"><span>location / {</span></span>
<span class="line"><span>       if ($http_user_agent ~ &#39;bingbot/2.0|MJ12bot/v1.4.2|Spider/3.0|YoudaoBot|Tomato|Gecko/20100315&#39;){</span></span>
<span class="line"><span>                return 403;</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>       }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="图片防盗链" tabindex="-1"><a class="header-anchor" href="#图片防盗链"><span>图片防盗链</span></a></h3><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-plain"><span class="line"><span>valid_referers none blocked *.XXX.com server_names ~\\.google\\. ~\\.baidu\\.;</span></span>
<span class="line"><span>                if ($invalid_referer) {</span></span>
<span class="line"><span>                        # return 403;</span></span>
<span class="line"><span>                        rewrite ^/ http://www.XXX.com/daoling.png;</span></span>
<span class="line"><span>                }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="不允许host为localhost访问" tabindex="-1"><a class="header-anchor" href="#不允许host为localhost访问"><span>不允许host为localhost访问</span></a></h3><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-plain"><span class="line"><span>if ($host = &#39;localhost&#39;) {</span></span>
<span class="line"><span>                return 403;</span></span>
<span class="line"><span>       }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="不允许agent为空" tabindex="-1"><a class="header-anchor" href="#不允许agent为空"><span>不允许agent为空</span></a></h3><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-plain"><span class="line"><span>if ($http_user_agent ~ ^$){</span></span>
<span class="line"><span>                return 403;</span></span>
<span class="line"><span>       }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="不允许绑定host主机访问" tabindex="-1"><a class="header-anchor" href="#不允许绑定host主机访问"><span>不允许绑定host主机访问</span></a></h3><div class="language-plain line-numbers-mode" data-highlighter="shiki" data-ext="plain" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-plain"><span class="line"><span>if ($http_x_forwarded_for ~ ^$){</span></span>
<span class="line"><span>                return 402;</span></span>
<span class="line"><span>       }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,110)]))}const t=a(l,[["render",d]]),c=JSON.parse('{"path":"/article/16kqhbmj/","title":"Linux-paicha","lang":"en-US","frontmatter":{"title":"Linux-paicha","createTime":"2025/05/27 17:51:17","permalink":"/article/16kqhbmj/"},"git":{"createdTime":1749111496000,"updatedTime":1750129445000,"contributors":[{"name":"star","username":"star","email":"star@xgss.net","commits":2,"url":"https://github.com/star"}]},"readingTime":{"minutes":4.47,"words":1341},"filePathRelative":"debug/Linux-paicha.md"}');export{t as comp,c as data};
