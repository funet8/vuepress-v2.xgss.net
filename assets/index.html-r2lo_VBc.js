import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,a as i,o as e}from"./app-BiQR_lPj.js";const l={};function p(d,s){return e(),a("div",null,s[0]||(s[0]=[i(`<h1 id="linux下安装lvs和keeplived实现负载均衡" tabindex="-1"><a class="header-anchor" href="#linux下安装lvs和keeplived实现负载均衡"><span>Linux下安装lvs和keeplived实现负载均衡</span></a></h1><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言"><span>前言</span></a></h2><p>在生产工作中，后端服务器并不可能永远都处于正常运行状态，若服务器发生宕机，为了不影响正在进行的业务以及给用户更好的体验，我们可以通过keepalived监控后台服务器运行情况，当有服务器发生故障时，会从把该服务器剔除出LVS转发策略；等到服务器恢复正常后，keepalived也会重新把该服务器加入LVS转发策略中。</p><p><img src="https://imgoss.xgss.net/picgo/lvskeepalived.png?aliyun" alt="lvskeepalived"></p><h2 id="系统介绍" tabindex="-1"><a class="header-anchor" href="#系统介绍"><span>系统介绍</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>虚拟VIP：192.168.1.231</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ip地址：192.168.1.244	【mac地址：00:16:3E:98:07:E8 ，以下简称D1】</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ip地址：192.168.1.233  【mac地址：00:16:3E:3B:60:AA，以下简称D1】</span></span>
<span class="line"><span></span></span>
<span class="line"><span>系统： centos6</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://imgoss.xgss.net/picgo/keepalived.png?aliyun" alt="keepalived"></p><h2 id="安装部署" tabindex="-1"><a class="header-anchor" href="#安装部署"><span>安装部署</span></a></h2><h3 id="安装keepalived" tabindex="-1"><a class="header-anchor" href="#安装keepalived"><span>安装keepalived</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>D1,D2服务器都要安装keepalived</span></span>
<span class="line"><span>cd /data/software/</span></span>
<span class="line"><span>rz 上传文件keepalived-1.2.13.tar.gz</span></span>
<span class="line"><span># tar -zvxf keepalived-1.2.13.tar.gz </span></span>
<span class="line"><span># cd keepalived-1.2.13</span></span>
<span class="line"><span># ./configure --sysconf=/data/conf/ --prefix=/data/apps/keepalived/ </span></span>
<span class="line"><span></span></span>
<span class="line"><span>\\# 如果报错!!! </span></span>
<span class="line"><span></span></span>
<span class="line"><span>OpenSSL is not properly installed on your system. !!! </span></span>
<span class="line"><span></span></span>
<span class="line"><span>则执行： </span></span>
<span class="line"><span></span></span>
<span class="line"><span># yum -y install openssl-devel</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>make</span></span>
<span class="line"><span>make install</span></span>
<span class="line"><span></span></span>
<span class="line"><span>安装完成</span></span>
<span class="line"><span>ln -s /data/apps/keepalived/sbin/keepalived /sbin/keepalived</span></span>
<span class="line"><span>cp /home/data/conf/rc.d/init.d/keepalived  /etc/rc.d/init.d/</span></span>
<span class="line"><span>cp /home/data/conf/sysconfig/keepalived /etc/sysconfig/</span></span>
<span class="line"><span>mkdir /etc/keepalived</span></span>
<span class="line"><span>cp /home/data/conf/keepalived/keepalived.conf /data/conf/</span></span>
<span class="line"><span>ln -s /data/conf/keepalived.conf  /etc/keepalived/keepalived.conf</span></span>
<span class="line"><span>rm -rf  /data/conf/keepalived /data/conf/rc.d /data/conf/sysconfig			</span></span>
<span class="line"><span>echo &quot;1&quot; &gt;/proc/sys/net/ipv4/ip_forward				# 开启路由功能</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="安装ipvs" tabindex="-1"><a class="header-anchor" href="#安装ipvs"><span>安装ipvs</span></a></h3><p>D1,D2服务器都要安装</p><p>检查kernel是否已经支持LVS的IPVS模块</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>modprobe -l | grep ipvs</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://imgoss.xgss.net/picgo/wps344F.tmp.jpg?aliyun" alt="img"></p><p>如果有类似上面的输出则说明内核已经支持</p><p>安装ipvs</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>yum -y install ipvsadm</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ipvsadm --help  (看到参数信息则说明安装成功)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://imgoss.xgss.net/picgo/wps3450.tmp.jpg?aliyun" alt="img"></p><h3 id="防火墙规则" tabindex="-1"><a class="header-anchor" href="#防火墙规则"><span>防火墙规则</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>iptables -F -t mangle		# 清空mangle中的规则</span></span>
<span class="line"><span></span></span>
<span class="line"><span>iptables -t mangle -I PREROUTING -d 192.168.1.231 -p tcp -m tcp --dport 80 -m mac ! --mac-source 00:16:3E:3B:60:AA -j MARK --set-mark 1	【192.168.1.244服务器配置】</span></span>
<span class="line"><span></span></span>
<span class="line"><span>iptables -t mangle -I PREROUTING -d 192.168.1.231 -p tcp -m tcp --dport 80 -m mac ! --mac-source 00:16:3E:98:07:E8 -j MARK --set-mark 1	【192.168.1.233服务器配置】</span></span>
<span class="line"><span></span></span>
<span class="line"><span> </span></span>
<span class="line"><span></span></span>
<span class="line"><span>\\# 目标ip地址是192.168.1.231并且目标端口为80的数据标记为1（排除另外一台lvs调度器 所以是排除另外一台调度器的mac地址 两台lvs的set-mark 值不同 并且规则中都排除对端的mac地址）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>service iptables save</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://imgoss.xgss.net/picgo/wps3451.tmp.jpg?aliyun" alt="img"></p><h3 id="配置keepalived" tabindex="-1"><a class="header-anchor" href="#配置keepalived"><span>配置keepalived</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>vi /etc/keepalived/keepalived.conf </span></span>
<span class="line"><span></span></span>
<span class="line"><span>修改配置信息参考：</span></span>
<span class="line"><span></span></span>
<span class="line"><span>192.168.1.244的配置：</span></span>
<span class="line"><span></span></span>
<span class="line"><span>! Configuration File for keepalived</span></span>
<span class="line"><span></span></span>
<span class="line"><span>global_defs {</span></span>
<span class="line"><span>	notification_email {</span></span>
<span class="line"><span>		linmaogan@gmail.com # 故障通知邮件地址，可以多个地址</span></span>
<span class="line"><span>		liuxing007xing@163.com</span></span>
<span class="line"><span>	}</span></span>
<span class="line"><span>	notification_email_from linmaogan@163.com # 故障发送人</span></span>
<span class="line"><span>	smtp_server smtp.163.com # 由163.com发送邮件</span></span>
<span class="line"><span>	smtp_connect_timeout 30</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	#运行Keepalived服务器的一个标识</span></span>
<span class="line"><span>	#发邮件时显示在邮件标题中的信息</span></span>
<span class="line"><span>	router_id LVS_BACKUP  #BACKUP上修改为LVS_BACKUP，网上资料说这个值也需要修改，具体不详，之前我们线上的主备就一直是一样的 ^ ^还是修改一下吧！</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 监测ipvsadm进程状态，每3秒执行一次</span></span>
<span class="line"><span>vrrp_script chk_ipvsadm{</span></span>
<span class="line"><span>    script &quot;/data/conf/shell/chk_ipvsadm.sh&quot;</span></span>
<span class="line"><span>    interval 3</span></span>
<span class="line"><span>    weight 3</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>vrrp_instance VI_1 {</span></span>
<span class="line"><span>    state MASTER</span></span>
<span class="line"><span>    interface em1		【修改对应的网卡或eth0】</span></span>
<span class="line"><span>    virtual_router_id 51</span></span>
<span class="line"><span>    priority 100</span></span>
<span class="line"><span>    advert_int 1</span></span>
<span class="line"><span>    authentication {</span></span>
<span class="line"><span>        auth_type PASS</span></span>
<span class="line"><span>        auth_pass PZFKD2wSUJ3swnPN</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    virtual_ipaddress {</span></span>
<span class="line"><span>        192.168.1.231</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>virtual_server fwmark 80 {</span></span>
<span class="line"><span>    delay_loop 6</span></span>
<span class="line"><span>    lb_algo wlc</span></span>
<span class="line"><span>    lb_kind DR</span></span>
<span class="line"><span>    persistence_timeout 1</span></span>
<span class="line"><span>    nat_mask 255.255.255.0   #网络掩码</span></span>
<span class="line"><span>	persistence_timeout 50 </span></span>
<span class="line"><span>	protocol TCP</span></span>
<span class="line"><span>    real_server 192.168.1.244 80 {</span></span>
<span class="line"><span>        weight 5</span></span>
<span class="line"><span>        TCP_CHECK {</span></span>
<span class="line"><span>            connect_timeout 3</span></span>
<span class="line"><span>            nb_get_retry 3</span></span>
<span class="line"><span>            delay_before_retry 3</span></span>
<span class="line"><span>			connect_port 80                #健康检查端口连接端口</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>	real_server 192.168.1.233 80 {</span></span>
<span class="line"><span>        weight 5</span></span>
<span class="line"><span>        TCP_CHECK {</span></span>
<span class="line"><span>            connect_timeout 3</span></span>
<span class="line"><span>            nb_get_retry 3</span></span>
<span class="line"><span>            delay_before_retry 3</span></span>
<span class="line"><span>			connect_port 80                #健康检查端口连接端口</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>192.168.1.233的配置：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>! Configuration File for keepalived</span></span>
<span class="line"><span></span></span>
<span class="line"><span>global_defs {</span></span>
<span class="line"><span>	notification_email {</span></span>
<span class="line"><span>		linmaogan@gmail.com # 故障通知邮件地址，可以多个地址</span></span>
<span class="line"><span>		liuxing007xing@163.com</span></span>
<span class="line"><span>	}</span></span>
<span class="line"><span>	notification_email_from linmaogan@163.com # 故障发送人</span></span>
<span class="line"><span>	smtp_server smtp.163.com # 由163.com发送邮件</span></span>
<span class="line"><span>	smtp_connect_timeout 30</span></span>
<span class="line"><span></span></span>
<span class="line"><span>	#运行Keepalived服务器的一个标识</span></span>
<span class="line"><span>	#发邮件时显示在邮件标题中的信息</span></span>
<span class="line"><span>	router_id LVS_BACKUP  #BACKUP上修改为LVS_BACKUP，网上资料说这个值也需要修改，具体不详，之前我们线上的主备就一直是一样的 ^ ^还是修改一下吧！</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span># 监测ipvsadm进程状态，每3秒执行一次</span></span>
<span class="line"><span>vrrp_script chk_ipvsadm{</span></span>
<span class="line"><span>    script &quot;/data/conf/shell/chk_ipvsadm.sh&quot;</span></span>
<span class="line"><span>    interval 3</span></span>
<span class="line"><span>    weight 3</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>vrrp_instance VI_1 {</span></span>
<span class="line"><span>    state BACKUP</span></span>
<span class="line"><span>    interface em1			【修改对应的网卡或eth0】</span></span>
<span class="line"><span>    virtual_router_id 51</span></span>
<span class="line"><span>    priority 80</span></span>
<span class="line"><span>    advert_int 1</span></span>
<span class="line"><span>    authentication {</span></span>
<span class="line"><span>        auth_type PASS</span></span>
<span class="line"><span>        auth_pass PZFKD2wSUJ3swnPN</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    virtual_ipaddress {</span></span>
<span class="line"><span>        192.168.1.231</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>virtual_server fwmark 80 {</span></span>
<span class="line"><span>    delay_loop 6</span></span>
<span class="line"><span>    lb_algo wlc</span></span>
<span class="line"><span>    lb_kind DR</span></span>
<span class="line"><span>    persistence_timeout 1</span></span>
<span class="line"><span>    nat_mask 255.255.255.0   #网络掩码</span></span>
<span class="line"><span>	persistence_timeout 50 </span></span>
<span class="line"><span>	protocol TCP</span></span>
<span class="line"><span>    real_server 192.168.1.244 80 {</span></span>
<span class="line"><span>        weight 5</span></span>
<span class="line"><span>        TCP_CHECK {</span></span>
<span class="line"><span>            connect_timeout 3</span></span>
<span class="line"><span>            nb_get_retry 3</span></span>
<span class="line"><span>            delay_before_retry 3</span></span>
<span class="line"><span>			connect_port 80                #健康检查端口连接端口</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>	real_server 192.168.1.233 80 {</span></span>
<span class="line"><span>        weight 5</span></span>
<span class="line"><span>        TCP_CHECK {</span></span>
<span class="line"><span>            connect_timeout 3</span></span>
<span class="line"><span>            nb_get_retry 3</span></span>
<span class="line"><span>            delay_before_retry 3</span></span>
<span class="line"><span>			connect_port 80                #健康检查端口连接端口</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>D2上配值和D1基本相同只是state MASTER改成state BACKUP,priority 100 改成 priority 80</p><h3 id="配置ipvs" tabindex="-1"><a class="header-anchor" href="#配置ipvs"><span>配置ipvs</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>vi /data/conf/shell/chk_ipvsadm.sh</span></span>
<span class="line"><span></span></span>
<span class="line"><span>插入配置信息</span></span>
<span class="line"><span>#!/bin/bash</span></span>
<span class="line"><span># 定时查看ipvsadm是否存在，如果不存在则启动ipvsadm，</span></span>
<span class="line"><span># 如果启动失败，则停止keepalived</span></span>
<span class="line"><span>status=$(ps aux|grep ipvsadm | grep -v grep | grep -v bash | wc -l)</span></span>
<span class="line"><span>if [ &quot;\${status}&quot; = &quot;0&quot; ]; then</span></span>
<span class="line"><span>	service ipvsadm start</span></span>
<span class="line"><span>	status2=$(ps aux|grep ipvsadm | grep -v grep | grep -v bash |wc -l)</span></span>
<span class="line"><span>	if [ &quot;\${status2}&quot; = &quot;0&quot;  ]; then</span></span>
<span class="line"><span>	/etc/init.d/keepalived stop</span></span>
<span class="line"><span>	 fi</span></span>
<span class="line"><span>fi</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="real-server上的配置" tabindex="-1"><a class="header-anchor" href="#real-server上的配置"><span>Real_Server上的配置</span></a></h3><p>在LVS的DR模式下，用户的访问请求到达Real Server 后，是直接返回给用户的，不再经过前端的Director Server,因此，需要在每个Real server节点上增加虚拟的VIP地址，这样数据才能直接返回给用户</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>chmod 777 /etc/rc.d/init.d/functions </span></span>
<span class="line"><span></span></span>
<span class="line"><span>vi /etc/init.d/lvsrs</span></span>
<span class="line"><span>#!/bin/bash</span></span>
<span class="line"><span>#把以下内容保存成:lvsrs</span></span>
<span class="line"><span>#并放置在/etc/init.d目录下</span></span>
<span class="line"><span>#如果想启动LVS Server执行:/etc/init.d/lvsrs start</span></span>
<span class="line"><span>#如果想停止LVS Server执行:/etc/init.d/lvsrs stop</span></span>
<span class="line"><span>VIP=192.168.1.231  #虚拟IP，视具体情况而变</span></span>
<span class="line"><span>. /etc/rc.d/init.d/functions   # 如果提示权限不够，那么先在命令行执行: chmod 777 /etc/rc.d/init.d/functions</span></span>
<span class="line"><span></span></span>
<span class="line"><span>case &quot;$1&quot; in</span></span>
<span class="line"><span>start)</span></span>
<span class="line"><span>	ifconfig lo:0 $VIP netmask 255.255.255.255 broadcast $VIP</span></span>
<span class="line"><span>	/sbin/route add -host $VIP dev lo:0</span></span>
<span class="line"><span>	echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span></span>
<span class="line"><span>	echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span></span>
<span class="line"><span>	echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span></span>
<span class="line"><span>	echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span></span>
<span class="line"><span>	sysctl -p &gt;/dev/null 2&gt;&amp;1</span></span>
<span class="line"><span>	echo &quot;RealServer Start OK&quot;</span></span>
<span class="line"><span>	;;</span></span>
<span class="line"><span>stop)</span></span>
<span class="line"><span>	ifconfig lo:0 down</span></span>
<span class="line"><span>	route del $VIP &gt;/dev/null 2&gt;&amp;1</span></span>
<span class="line"><span>	echo &quot;0&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span></span>
<span class="line"><span>	echo &quot;0&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</span></span>
<span class="line"><span>	echo &quot;0&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span></span>
<span class="line"><span>	echo &quot;0&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span></span>
<span class="line"><span>	echo &quot;RealServer Stoped&quot;</span></span>
<span class="line"><span>	;;</span></span>
<span class="line"><span>	*)</span></span>
<span class="line"><span>	echo &quot;Usage: $0 {start|stop}&quot;</span></span>
<span class="line"><span>	exit 1</span></span>
<span class="line"><span>esac</span></span>
<span class="line"><span>exit 0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>chmod 755 /etc/init.d/lvsrs</span></span>
<span class="line"><span></span></span>
<span class="line"><span>service lvsrs start</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="管理lvs" tabindex="-1"><a class="header-anchor" href="#管理lvs"><span>管理lvs</span></a></h3><p>以下D1,D2上都执行</p><p>1）启动lvs调度器</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>service keepalived start							# 开启路由功能</span></span>
<span class="line"><span>echo &quot;1&quot; &gt;/proc/sys/net/ipv4/ip_forward</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>2） 关闭lvs调度器</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>service keepalived stop</span></span>
<span class="line"><span>echo &quot;0&quot; &gt;/proc/sys/net/ipv4/ip_forward</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="添加开机启动" tabindex="-1"><a class="header-anchor" href="#添加开机启动"><span>添加开机启动</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>chkconfig --add keepalived</span></span>
<span class="line"><span>chkconfig keepalived on</span></span>
<span class="line"><span></span></span>
<span class="line"><span>vi /etc/rc.d/rc.local</span></span>
<span class="line"><span>/etc/init.d/lvsrs start  # 添加这一行到末尾</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ip a 查询</p><p><img src="https://imgoss.xgss.net/picgo/wps3467.tmp.jpg?aliyun" alt="img"></p>`,44)]))}const v=n(l,[["render",p]]),t=JSON.parse('{"path":"/article/xl3vq5nh/","title":"Linux下安装lvs和keeplived实现负载均衡","lang":"en-US","frontmatter":{"title":"Linux下安装lvs和keeplived实现负载均衡","createTime":"2025/05/27 17:51:18","permalink":"/article/xl3vq5nh/"},"git":{"createdTime":1749111496000,"updatedTime":1750129445000,"contributors":[{"name":"star","username":"star","email":"star@xgss.net","commits":2,"url":"https://github.com/star"}]},"readingTime":{"minutes":4.86,"words":1458},"filePathRelative":"web/Linux下安装lvs和keeplived实现负载均衡.md"}');export{v as comp,t as data};
