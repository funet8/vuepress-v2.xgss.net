import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,a as n,o as l}from"./app-BiQR_lPj.js";const t={};function e(h,s){return l(),a("div",null,s[0]||(s[0]=[n(`<h1 id="rsync-lsyncd-的高效文件实时同步系统" tabindex="-1"><a class="header-anchor" href="#rsync-lsyncd-的高效文件实时同步系统"><span>rsync + lsyncd 的高效文件实时同步系统</span></a></h1><p>我们来直接上干货，帮你搭建一个 <strong>rsync + lsyncd</strong> 的高效文件实时同步系统。 这个方案在 <strong>低延迟、低资源占用、跨机房实时同步</strong> 场景里非常稳，尤其适合你这种追求高效落地的技术风格。</p><hr><h2 id="系统架构思路" tabindex="-1"><a class="header-anchor" href="#系统架构思路"><span>系统架构思路</span></a></h2><p><strong>核心原理</strong></p><ul><li><strong>lsyncd</strong>（Live Syncing Daemon）实时监听本地目录变化（inotify 机制）</li><li>变化事件触发 <strong>rsync</strong> 增量同步到目标服务器</li><li>支持批量事件合并，减少频繁调用 rsync 带来的开销</li><li>rsync 负责数据传输与差异比对，支持压缩、断点续传、权限保持</li></ul><p><strong>架构图</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>[源服务器] --(inotify监听)--&gt; [lsyncd] --(触发rsync)--&gt; [目标服务器]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="https://imgoss.xgss.net/picgo-tx2025/image-20250826105452996.png?tx" alt="image-20250826105452996"></p><hr><h2 id="安装与配置" tabindex="-1"><a class="header-anchor" href="#安装与配置"><span>安装与配置</span></a></h2><h3 id="_1-安装依赖" tabindex="-1"><a class="header-anchor" href="#_1-安装依赖"><span>1. 安装依赖</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 源服务器 &amp; 目标服务器都需要 rsync</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> rsync</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -y</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 源服务器安装 lsyncd</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> apt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> lsyncd</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -y</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_2-ssh-免密登录-避免每次输入密码" tabindex="-1"><a class="header-anchor" href="#_2-ssh-免密登录-避免每次输入密码"><span>2. SSH 免密登录（避免每次输入密码）</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ssh-keygen</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -t</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> rsa</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ssh-copy-id</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> user@target_host</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_3-lsyncd-配置文件-etc-lsyncd-lsyncd-conf-lua" tabindex="-1"><a class="header-anchor" href="#_3-lsyncd-配置文件-etc-lsyncd-lsyncd-conf-lua"><span>3. lsyncd 配置文件（<code>/etc/lsyncd/lsyncd.conf.lua</code>）</span></a></h3><div class="language-lua line-numbers-mode" data-highlighter="shiki" data-ext="lua" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-lua"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">settings</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    logfile</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/var/log/lsyncd/lsyncd.log&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    statusFile</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/var/log/lsyncd/lsyncd.status&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    statusInterval</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">20</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    default</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.rsync,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    source</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/data/www&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,   </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 需要同步的目录</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    target</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user@target_host:/data/www&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    rsync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        archive</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,    </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 保留权限、时间戳等</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        compress</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,    </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 压缩传输</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        verbose</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        _extra</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   = {</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;--bwlimit=5000&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">-- 限速，单位KB/s，可选</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    },</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    delay</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  -- 延迟合并事件，减少频繁调用</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_4-启动与开机自启" tabindex="-1"><a class="header-anchor" href="#_4-启动与开机自启"><span>4. 启动与开机自启</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> enable</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> lsyncd</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> systemctl</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> start</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> lsyncd</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="性能优化建议" tabindex="-1"><a class="header-anchor" href="#性能优化建议"><span>性能优化建议</span></a></h2><table><thead><tr><th>优化点</th><th>说明</th></tr></thead><tbody><tr><td><strong>inotify 限制</strong></td><td>调整 <code>/proc/sys/fs/inotify/max_user_watches</code>，避免监听目录过多时报错</td></tr><tr><td><strong>rsync 参数</strong></td><td><code>--inplace</code> 避免临时文件，<code>--partial</code> 支持断点续传</td></tr><tr><td><strong>网络优化</strong></td><td>内网可关闭压缩（<code>compress=false</code>），减少 CPU 占用</td></tr><tr><td><strong>批量延迟</strong></td><td><code>delay</code> 参数可根据业务调整，减少频繁触发</td></tr><tr><td><strong>安全</strong></td><td>建议配合 <code>--rsync-path=&quot;rsync --fake-super&quot;</code> 或 chroot 限制权限</td></tr></tbody></table><hr><h2 id="适用场景" tabindex="-1"><a class="header-anchor" href="#适用场景"><span>适用场景</span></a></h2><ul><li><strong>Web 服务器集群</strong>：代码、静态资源实时分发</li><li><strong>日志收集</strong>：边写边同步到分析节点</li><li><strong>跨机房热备</strong>：低延迟异地容灾</li></ul><hr><h2 id="进阶玩法" tabindex="-1"><a class="header-anchor" href="#进阶玩法"><span>进阶玩法</span></a></h2><ul><li><strong>多目标同步</strong>：一台源机同时推送到多台目标机（多 <code>sync{}</code> 配置块）</li><li><strong>结合 Docker</strong>：容器卷挂载 + lsyncd 实现容器间实时同步</li><li><strong>结合 WAF/安全审计</strong>：同步前做文件校验，防止恶意代码传播</li></ul>`,31)]))}const k=i(t,[["render",e]]),p=JSON.parse('{"path":"/%E6%99%BA%E7%BB%B4%E6%94%BB%E5%9F%8E%E7%8B%AE/S15/1.rsync-lsyncd%E7%9A%84%E9%AB%98%E6%95%88%E6%96%87%E4%BB%B6%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5%E7%B3%BB%E7%BB%9F.html","title":"rsync + lsyncd 的高效文件实时同步系统","lang":"en-US","frontmatter":{},"git":{"createdTime":1756914694000,"updatedTime":1761640845000,"contributors":[{"name":"star","username":"star","email":"star@xgss.net","commits":2,"url":"https://github.com/star"}]},"readingTime":{"minutes":1.89,"words":566},"filePathRelative":"智维攻城狮/S15/1.rsync-lsyncd的高效文件实时同步系统.md"}');export{k as comp,p as data};
