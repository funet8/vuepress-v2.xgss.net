import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,a as e,o as i}from"./app-BiQR_lPj.js";const l={};function p(d,s){return i(),a("div",null,s[0]||(s[0]=[e(`<h1 id="打造零故障架构-基于-keepalived-的-nginx-和-haproxy-高可用实战指南" tabindex="-1"><a class="header-anchor" href="#打造零故障架构-基于-keepalived-的-nginx-和-haproxy-高可用实战指南"><span>打造零故障架构：基于 Keepalived 的 Nginx 和 HAProxy 高可用实战指南</span></a></h1><h2 id="一、为什么要上-keepalived-高可用" tabindex="-1"><a class="header-anchor" href="#一、为什么要上-keepalived-高可用"><span>一、为什么要上 Keepalived 高可用？</span></a></h2><p>在生产环境中，<strong>单点故障（SPOF）</strong> 是架构稳定性的最大敌人。 无论是 <strong>Nginx</strong> 还是 <strong>HAProxy</strong>，一旦入口节点宕机，整个业务就会中断。 Keepalived 的作用就是——<strong>让入口节点“永不宕机”</strong>。</p><ul><li><strong>核心原理</strong>：通过 VRRP 协议在多台服务器之间漂移一个虚拟 IP（VIP）</li><li><strong>效果</strong>：主节点挂了，VIP 自动切换到备节点，业务无感知</li></ul><h2 id="二、架构拓扑" tabindex="-1"><a class="header-anchor" href="#二、架构拓扑"><span>二、架构拓扑</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>        ┌──────────────┐</span></span>
<span class="line"><span>        │   Client     │</span></span>
<span class="line"><span>        └──────┬───────┘</span></span>
<span class="line"><span>               │</span></span>
<span class="line"><span>         VIP: 192.168.1.100</span></span>
<span class="line"><span>               │</span></span>
<span class="line"><span>    ┌──────────┴──────────┐</span></span>
<span class="line"><span>    │                     │</span></span>
<span class="line"><span>┌───▼───┐           ┌─────▼────┐</span></span>
<span class="line"><span>│ Nginx │           │ HAProxy  │</span></span>
<span class="line"><span>│ Master│           │ Backup   │</span></span>
<span class="line"><span>└───┬───┘           └─────┬────┘</span></span>
<span class="line"><span>    │                     │</span></span>
<span class="line"><span>    └──────────┬──────────┘</span></span>
<span class="line"><span>               │</span></span>
<span class="line"><span>         ┌─────▼─────┐</span></span>
<span class="line"><span>         │  Backend  │</span></span>
<span class="line"><span>         └───────────┘</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://imgoss.xgss.net/picgo-tx2025/image-20250826112150694.png?tx" alt="image-20250826112150694"></p><h2 id="三、环境准备" tabindex="-1"><a class="header-anchor" href="#三、环境准备"><span>三、环境准备</span></a></h2><table><thead><tr><th>节点角色</th><th>主机名</th><th>IP 地址</th><th>说明</th></tr></thead><tbody><tr><td>Master</td><td>lb01</td><td>192.168.1.11</td><td>主入口</td></tr><tr><td>Backup</td><td>lb02</td><td>192.168.1.12</td><td>备用入口</td></tr><tr><td>VIP</td><td>-</td><td>192.168.1.100</td><td>漂移 IP</td></tr></tbody></table><h2 id="四、安装-keepalived" tabindex="-1"><a class="header-anchor" href="#四、安装-keepalived"><span>四、安装 Keepalived</span></a></h2><p><strong>CentOS / RHEL 系列</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>yum install -y keepalived</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>Debian / Ubuntu 系列</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>apt-get update &amp;&amp; apt-get install -y keepalived</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="五、配置-keepalived" tabindex="-1"><a class="header-anchor" href="#五、配置-keepalived"><span>五、配置 Keepalived</span></a></h2><h3 id="_1-master-节点-etc-keepalived-keepalived-conf" tabindex="-1"><a class="header-anchor" href="#_1-master-节点-etc-keepalived-keepalived-conf"><span>1. Master 节点 <code>/etc/keepalived/keepalived.conf</code></span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>vrrp_instance VI_1 {</span></span>
<span class="line"><span>    state MASTER</span></span>
<span class="line"><span>    interface eth0</span></span>
<span class="line"><span>    virtual_router_id 51</span></span>
<span class="line"><span>    priority 100</span></span>
<span class="line"><span>    advert_int 1</span></span>
<span class="line"><span>    authentication {</span></span>
<span class="line"><span>        auth_type PASS</span></span>
<span class="line"><span>        auth_pass 123456</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    virtual_ipaddress {</span></span>
<span class="line"><span>        192.168.1.100/24</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    track_script {</span></span>
<span class="line"><span>        chk_nginx</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>vrrp_script chk_nginx {</span></span>
<span class="line"><span>    script &quot;/etc/keepalived/check_nginx.sh&quot;</span></span>
<span class="line"><span>    interval 2</span></span>
<span class="line"><span>    weight -20</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-backup-节点" tabindex="-1"><a class="header-anchor" href="#_2-backup-节点"><span>2. Backup 节点</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>vrrp_instance VI_1 {</span></span>
<span class="line"><span>    state BACKUP</span></span>
<span class="line"><span>    interface eth0</span></span>
<span class="line"><span>    virtual_router_id 51</span></span>
<span class="line"><span>    priority 90</span></span>
<span class="line"><span>    advert_int 1</span></span>
<span class="line"><span>    authentication {</span></span>
<span class="line"><span>        auth_type PASS</span></span>
<span class="line"><span>        auth_pass 123456</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    virtual_ipaddress {</span></span>
<span class="line"><span>        192.168.1.100/24</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    track_script {</span></span>
<span class="line"><span>        chk_nginx</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>vrrp_script chk_nginx {</span></span>
<span class="line"><span>    script &quot;/etc/keepalived/check_nginx.sh&quot;</span></span>
<span class="line"><span>    interval 2</span></span>
<span class="line"><span>    weight -20</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="六、健康检查脚本" tabindex="-1"><a class="header-anchor" href="#六、健康检查脚本"><span>六、健康检查脚本</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>vi /etc/keepalived/check_nginx.sh</span></span>
<span class="line"><span>把以下内容填入</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>#!/bin/bash</span></span>
<span class="line"><span>if ! pgrep nginx &gt; /dev/null; then</span></span>
<span class="line"><span>    systemctl start nginx</span></span>
<span class="line"><span>    sleep 2</span></span>
<span class="line"><span>    if ! pgrep nginx &gt; /dev/null; then</span></span>
<span class="line"><span>        exit 1</span></span>
<span class="line"><span>    fi</span></span>
<span class="line"><span>fi</span></span>
<span class="line"><span>exit 0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>给到执行权限</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>chmod +x /etc/keepalived/check_nginx.sh</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="七、启动与验证" tabindex="-1"><a class="header-anchor" href="#七、启动与验证"><span>七、启动与验证</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>systemctl enable keepalived --now</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>在 Master 上执行：</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>ip addr show eth0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>应看到 VIP <code>192.168.1.100</code> 已绑定</p><ul><li>停止 Master 的 Nginx 或 Keepalived：</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>systemctl stop nginx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>几秒后，VIP 会自动漂移到 Backup 节点</p><h2 id="八、结合-haproxy-的高可用" tabindex="-1"><a class="header-anchor" href="#八、结合-haproxy-的高可用"><span>八、结合 HAProxy 的高可用</span></a></h2><p>如果入口层是 <strong>HAProxy</strong>，只需将健康检查脚本改为：</p><p>bash</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>#!/bin/bash</span></span>
<span class="line"><span>if ! pgrep haproxy &gt; /dev/null; then</span></span>
<span class="line"><span>    systemctl start haproxy</span></span>
<span class="line"><span>    sleep 2</span></span>
<span class="line"><span>    if ! pgrep haproxy &gt; /dev/null; then</span></span>
<span class="line"><span>        exit 1</span></span>
<span class="line"><span>    fi</span></span>
<span class="line"><span>fi</span></span>
<span class="line"><span>exit 0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="九、生产优化建议" tabindex="-1"><a class="header-anchor" href="#九、生产优化建议"><span>九、生产优化建议</span></a></h2><ol><li><strong>双向健康检查</strong>：不仅检测进程，还可检测端口或 HTTP 状态码</li><li><strong>防脑裂</strong>：结合 <code>unicast_peer</code> 或 <code>notify</code> 脚本，避免双主</li><li><strong>日志监控</strong>：开启 Keepalived 日志，方便故障排查</li><li><strong>自动化部署</strong>：用 Ansible/SaltStack 批量推送配置</li></ol><h2 id="十、总结" tabindex="-1"><a class="header-anchor" href="#十、总结"><span>十、总结</span></a></h2><p>通过 <strong>Keepalived + Nginx/HAProxy</strong>，我们可以在入口层实现<strong>秒级故障切换</strong>，让业务在节点宕机时依然平稳运行。 这套方案部署简单、成本低，非常适合中小型企业和高可用入门实践。</p>`,40)]))}const c=n(l,[["render",p]]),h=JSON.parse('{"path":"/%E6%99%BA%E7%BB%B4%E6%94%BB%E5%9F%8E%E7%8B%AE/S15/2.%E5%9F%BA%E4%BA%8EKeepalived%E7%9A%84Nginx%E5%92%8CHAProxy%20%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97.html","title":"打造零故障架构：基于 Keepalived 的 Nginx 和 HAProxy 高可用实战指南","lang":"en-US","frontmatter":{},"git":{"createdTime":1756914694000,"updatedTime":1761640845000,"contributors":[{"name":"star","username":"star","email":"star@xgss.net","commits":2,"url":"https://github.com/star"}]},"readingTime":{"minutes":1.92,"words":577},"filePathRelative":"智维攻城狮/S15/2.基于Keepalived的Nginx和HAProxy 高可用实战指南.md"}');export{c as comp,h as data};
