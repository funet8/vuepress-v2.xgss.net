import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as n,a as i,o as e}from"./app-BiQR_lPj.js";const l={};function p(d,s){return e(),n("div",null,s[0]||(s[0]=[i(`<h1 id="nginx从入门到放弃06-nginx的n种特别实用示例" tabindex="-1"><a class="header-anchor" href="#nginx从入门到放弃06-nginx的n种特别实用示例"><span>Nginx从入门到放弃06-Nginx的N种特别实用示例</span></a></h1><p>从前面的几篇教程里面我们知道了nginx的安装和调优、负载均衡、反向代理等，这篇文档我们来介绍Nginx的N种特别实用示例</p><p>笔者把自己总结的文档分为几遍，合集在 https://g.xgss.net/nginx/</p><p><img src="https://imgoss.xgss.net/picgo/nginx06.jpg?aliyun" alt="nginx06"></p><h1 id="一、location" tabindex="-1"><a class="header-anchor" href="#一、location"><span>一、location</span></a></h1><p>location块负责匹配url，root指令负责将匹配到的url与服务器中某个具体目录对应起来。</p><p>语法规则：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location [=|~|~*|^~] /uri/ { … }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>location优先级</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>(location =) &gt; (location 完整路径 ) &gt;(location ^~ 路径) &gt;(location ~*, ~ 正则) &gt;(location 部分起始路径) 正则表达式根据配置文件中的前后顺序影响匹配, 前面的优先匹配. 其它则根据匹配长度来优先匹配.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="精确匹配-开头" tabindex="-1"><a class="header-anchor" href="#精确匹配-开头"><span>精确匹配(=开头)</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location = / {		</span></span>
<span class="line"><span>   #规则A</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>location = /login {</span></span>
<span class="line"><span>   #规则B</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="开头某个常规字符串" tabindex="-1"><a class="header-anchor" href="#开头某个常规字符串"><span>^~ 开头某个常规字符串</span></a></h3><p>表示uri以某个常规字符串开头，理解为匹配url路径即可。nginx不对url做编码，因此请求为/static/20%/aa，可以被规则^~ /static/ /aa匹配到（注意是空格）。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location ^~ /static/ {	</span></span>
<span class="line"><span>   #规则C</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="区分大小写-开头" tabindex="-1"><a class="header-anchor" href="#区分大小写-开头"><span>区分大小写(~ 开头)</span></a></h3><p>表示区分大小写的正则匹配</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location ~ \\.(gif|jpg|png|js|css)$ {</span></span>
<span class="line"><span>   #规则D</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="不区分大小写-开头" tabindex="-1"><a class="header-anchor" href="#不区分大小写-开头"><span>不区分大小写(~*开头)</span></a></h3><p>表示不区分大小写的正则匹配</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location ~* \\.png$ {</span></span>
<span class="line"><span>   #规则E</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="和-表示" tabindex="-1"><a class="header-anchor" href="#和-表示"><span>!~和!~*表示</span></a></h3><p>分别为区分大小写不匹配及不区分大小写不匹配 的正则</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location !~ \\.xhtml$ {</span></span>
<span class="line"><span>   #规则F</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>location !~* \\.xhtml$ {</span></span>
<span class="line"><span>   #规则G</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="通用匹配-开头" tabindex="-1"><a class="header-anchor" href="#通用匹配-开头"><span>通用匹配(/ 开头)</span></a></h3><p>任何请求都会匹配到。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location / {</span></span>
<span class="line"><span>   #规则H</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="二、nginx实用实例" tabindex="-1"><a class="header-anchor" href="#二、nginx实用实例"><span>二、Nginx实用实例</span></a></h1><h3 id="_1-设置缓存时间" tabindex="-1"><a class="header-anchor" href="#_1-设置缓存时间"><span>1.设置缓存时间</span></a></h3><p>控制图片、HTML等静态文件过期时间为30天，当然这个时间可以设置的更长。具体视情况而定</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location ~ .*\\.(htm|html|css|js|jpg|jpeg|gif|png|ico|bmp|gz|xml|zip|rar|swf|txt|xls|xlsx|flv|mid|doc|ppt|pdf|mp3|wma|exe)?$ {</span></span>
<span class="line"><span>                root /data/pic/;</span></span>
<span class="line"><span>                expires     30d;</span></span>
<span class="line"><span>                access_log /dev/null;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>expires设置缓存时间</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>expires [time|epoch|max|off]</span></span>
<span class="line"><span>expires epoch 指定“Expires”的值为 1 January, 1970, 00:00:01 GMT。</span></span>
<span class="line"><span>expires max 指定“Expires”的值为 31 December 2037 23:59:59 GMT，“Cache-Control”的值为10年。</span></span>
<span class="line"><span>expires -1 指定“Expires”的值为 服务器当前时间 -1s,即永远过期</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-http跳转到https" tabindex="-1"><a class="header-anchor" href="#_2-http跳转到https"><span>2.HTTP跳转到HTTPS</span></a></h3><p>如下http80端口项目301跳转到https</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>server {</span></span>
<span class="line"><span>  listen       80;</span></span>
<span class="line"><span>  server_name  www.test.com;</span></span>
<span class="line"><span>  return 301   https://$host$request_uri;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if ($host = &#39;test.com&#39;) {</span></span>
<span class="line"><span>        rewrite ^/(.*)$ https://www.test.com/$1 permanent;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>https配置，需要获取域名证书。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>server {</span></span>
<span class="line"><span>        listen       443;</span></span>
<span class="line"><span>        server_name  www.test.com;</span></span>
<span class="line"><span>        root /data/wwwroot/www.test.com/;</span></span>
<span class="line"><span>        access_log /data/wwwroot/log/ssl_www.test.com-access.log;</span></span>
<span class="line"><span>        error_log /dev/null;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>		ssl on;</span></span>
<span class="line"><span>		ssl_certificate /data/wwwroot/cert/www.test.com.pem;</span></span>
<span class="line"><span>		ssl_certificate_key /data/wwwroot/cert/www.test.com.key;</span></span>
<span class="line"><span>		ssl_session_timeout 5m;</span></span>
<span class="line"><span>		ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span></span>
<span class="line"><span>		ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span></span>
<span class="line"><span>		ssl_prefer_server_ciphers on;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        location / {</span></span>
<span class="line"><span>                index  index.html index.htm index.php;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-设置404页面" tabindex="-1"><a class="header-anchor" href="#_3-设置404页面"><span>3.设置404页面</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>error_page 404 = http://www.baidu.com/hot/jmb/?from=404_hlx&amp;404_url=$scheme://$host$request_uri&amp;404_from=$http_referer;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>解释：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>http://www.nginx01.com/1111?from=testpage</span></span>
<span class="line"><span>如果是404则会跳转到：</span></span>
<span class="line"><span>https://www.baidu.com/hot/jmb/?from=404_hlx&amp;404_url=http://www.nginx01.com/1111?from=testpage&amp;404_from=</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-配置php不缓存" tabindex="-1"><a class="header-anchor" href="#_4-配置php不缓存"><span>4.配置PHP不缓存</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location ~ .*/.(php|php5)?$ {        </span></span>
<span class="line"><span>	add_header Cache-Control no-cache;    </span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-禁止特定用户代理-user-agents-访问" tabindex="-1"><a class="header-anchor" href="#_5-禁止特定用户代理-user-agents-访问"><span>5.禁止特定用户代理（User Agents）访问</span></a></h3><p>禁止某些工具，或者搜索引擎蜘蛛爬取</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>if ($http_user_agent ~* (wget|curl|Firefox) ) {</span></span>
<span class="line"><span>	return 404;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>禁止神马搜索</span></span>
<span class="line"><span>if ($http_user_agent ~* &quot;YisouSpider&quot;) {</span></span>
<span class="line"><span>	return 403;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>禁止useragent为空</span></span>
<span class="line"><span>if ($http_user_agent ~ ^$){</span></span>
<span class="line"><span>	return 403;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-忽略favicon-ico文件的错误日志" tabindex="-1"><a class="header-anchor" href="#_6-忽略favicon-ico文件的错误日志"><span>6.忽略favicon.ico文件的错误日志</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location = /favicon.ico {</span></span>
<span class="line"><span>    log_not_found off;</span></span>
<span class="line"><span>    access_log /dev/null;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-禁止某些目录php解析" tabindex="-1"><a class="header-anchor" href="#_7-禁止某些目录php解析"><span>7.禁止某些目录php解析</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location ~ .*(diy|template|attachments|forumdata|attachment|image)/.*\\.php$ {</span></span>
<span class="line"><span>        deny all;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-日志不记录head方法" tabindex="-1"><a class="header-anchor" href="#_8-日志不记录head方法"><span>8.日志不记录HEAD方法</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>#日志不记录HEAD方法</span></span>
<span class="line"><span>if ($request_method = HEAD) {</span></span>
<span class="line"><span>    access_log off;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-nginx密码认证" tabindex="-1"><a class="header-anchor" href="#_9-nginx密码认证"><span>9.nginx密码认证</span></a></h3><p>HTTP Basic Authentication协议验证的页面</p><p>新建密码文件：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># yum -y install httpd-tools</span></span>
<span class="line"><span># printf &quot;admin:$(openssl passwd -crypt 123456)\\n&quot; &gt;&gt;/data/conf/sites-available/htpasswd</span></span>
<span class="line"><span># cat /data/conf/sites-available/htpasswd</span></span>
<span class="line"><span>admin:X2dW2ryA9hA7M</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置密码：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location /php {</span></span>
<span class="line"><span>                #密码认证</span></span>
<span class="line"><span>                auth_basic &quot;nginx basic auth&quot;;</span></span>
<span class="line"><span>                auth_basic_user_file /data/conf/sites-available/htpasswd;</span></span>
<span class="line"><span>                autoindex on;</span></span>
<span class="line"><span>    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>浏览器访问：</p><p><img src="https://imgoss.xgss.net/picgo/image-20220624114045776.png?aliyun" alt="image-20220624114045776"></p><p>输入 admin 和123456即可进入。</p><p>对于这种有HTTP Basic Authentication协议验证的页面，如果使用curl抓取的话，可以加上账号密码进行请求：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>curl请求：</span></span>
<span class="line"><span># curl -u username:password URL</span></span>
<span class="line"><span>例如：  curl -u admin:123456 http://www.nginx01.com/php</span></span>
<span class="line"><span>如果用wget下载,可以用：</span></span>
<span class="line"><span># wget --http-user= --http-passwd=passwd URL</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_10-nginx屏蔽ip方法" tabindex="-1"><a class="header-anchor" href="#_10-nginx屏蔽ip方法"><span>10.nginx屏蔽ip方法</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>deny 219.133.188.183; </span></span>
<span class="line"><span>deny 10.0.1.0/24;</span></span>
<span class="line"><span>#屏蔽单个IP的命令是</span></span>
<span class="line"><span>deny 123.45.6.7</span></span>
<span class="line"><span>#封整个段即从123.0.0.1到123.255.255.254的命令</span></span>
<span class="line"><span>deny 123.0.0.0/8</span></span>
<span class="line"><span>#封IP段即从123.45.0.1到123.45.255.254的命令</span></span>
<span class="line"><span>deny 124.45.0.0/16</span></span>
<span class="line"><span>#封IP段即从 123.45.6.1到123.45.6.254的命令是</span></span>
<span class="line"><span>deny 123.45.6.0/24</span></span>
<span class="line"><span>allow 1.1.1.1; </span></span>
<span class="line"><span>allow 1.1.1.2;</span></span>
<span class="line"><span>deny all; </span></span>
<span class="line"><span>location / {</span></span>
<span class="line"><span>    allow 1.1.1.2;</span></span>
<span class="line"><span>    deny all;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-阿里云slb场景使用nginx封用户真实ip" tabindex="-1"><a class="header-anchor" href="#_11-阿里云slb场景使用nginx封用户真实ip"><span>11.阿里云SLB场景使用NGINX封用户真实IP</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>set $allow true;</span></span>
<span class="line"><span>if ($http_x_forwarded_for ~ &quot;106.121.*.*|106.121.71.120|106.121.77.28|106.121.74.130|218.109.235.254&quot;){</span></span>
<span class="line"><span>	set $allow false;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>if ($allow = false){</span></span>
<span class="line"><span>	return 404;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_12-禁止代理ip访问-http-x-forwarded-for" tabindex="-1"><a class="header-anchor" href="#_12-禁止代理ip访问-http-x-forwarded-for"><span>12.禁止代理IP访问（http_x_forwarded_for）</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>if ($http_x_forwarded_for ~ (^192\\.168\\.1\\.2$)){</span></span>
<span class="line"><span>         return 403;       </span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_13-禁止ip段-192-168-3-142-192-168-3-147" tabindex="-1"><a class="header-anchor" href="#_13-禁止ip段-192-168-3-142-192-168-3-147"><span>13.禁止IP段：192.168.3.142~192.168.3.147</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>if ($http_x_forwarded_for ~ (^192\\.168\\.3\\.14[2-7]$)){</span></span>
<span class="line"><span>                return 403;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if ($http_x_forwarded_for ~ (^183\\.61\\.51\\.[51-70])){</span></span>
<span class="line"><span>                return 403;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_14-禁止ip段-192-168-64-0-192-168-95-255" tabindex="-1"><a class="header-anchor" href="#_14-禁止ip段-192-168-64-0-192-168-95-255"><span>14.禁止IP段： 192.168.64.0~192.168.95.255</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>if ($http_x_forwarded_for ~ (^192\\.168\\.[7-8][0-9]\\.\\d+$|^192\\.168\\.[6][4-9]\\.\\d+$|^192\\.168\\.[9][0-5]\\.\\d+$)){</span></span>
<span class="line"><span>                return 403;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_15-禁止多个ip" tabindex="-1"><a class="header-anchor" href="#_15-禁止多个ip"><span>15.禁止多个ip</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>if ($http_x_forwarded_for ~ &quot;223.128.4.250|91.200.12.93&quot;) {</span></span>
<span class="line"><span>     return 403;     </span></span>
<span class="line"><span>  }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_16-禁止ip段-192-168-3-0-254" tabindex="-1"><a class="header-anchor" href="#_16-禁止ip段-192-168-3-0-254"><span>16.禁止IP段：192.168.3.0~254</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>if ($http_x_forwarded_for ~ (^192\\.168\\.3\\.[0-254]$)){</span></span>
<span class="line"><span>	return 403;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_17-nginx允许跨域" tabindex="-1"><a class="header-anchor" href="#_17-nginx允许跨域"><span>17.nginx允许跨域</span></a></h3><p>当出现403跨域错误的时候 No &#39;Access-Control-Allow-Origin&#39; header is present on the requested resource，需要给Nginx服务器配置响应的header参数：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>  add_header Access-Control-Allow-Origin *;</span></span>
<span class="line"><span>  add_header Access-Control-Allow-Headers X-Requested-With;</span></span>
<span class="line"><span>  add_header Access-Control-Allow-Methods GET,POST,OPTIONS;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>服务器默认是不被允许跨域的。给Nginx服务器配置<code>Access-Control-Allow-Origin *</code>后，表示服务器可以接受所有的请求源（Origin）,即接受所有跨域的请求。</p><p>Access-Control-Allow-Headers 是为了防止出现以下错误： Request header field Content-Type is not allowed by Access-Control-Allow-Headers in preflight response.</p><p>这个错误表示当前请求Content-Type的值不被支持。其实是我们发起了&quot;application/json&quot;的类型请求导致的。这里涉及到一个概念：预检请求（preflight request）,请看下面&quot;预检请求&quot;的介绍。</p><p>Access-Control-Allow-Methods 是为了防止出现以下错误： Content-Type is not allowed by Access-Control-Allow-Headers in preflight response.</p><p>给OPTIONS 添加 204的返回，是为了处理在发送POST请求时Nginx依然拒绝访问的错误 发送&quot;预检请求&quot;时，需要用到方法 OPTIONS ,所以服务器需要允许该方法。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location / {  </span></span>
<span class="line"><span>    add_header Access-Control-Allow-Origin *;</span></span>
<span class="line"><span>    add_header Access-Control-Allow-Methods &#39;GET, POST, OPTIONS&#39;;</span></span>
<span class="line"><span>    add_header Access-Control-Allow-Headers &#39;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if ($request_method = &#39;OPTIONS&#39;) {</span></span>
<span class="line"><span>        return 204;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_18-nginx日志记录post参数" tabindex="-1"><a class="header-anchor" href="#_18-nginx日志记录post参数"><span>18.nginx日志记录post参数</span></a></h3><p>其实我们只需要把 $request_body 参数加入自定义日志记录信息中即可。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>log_format  main_aliyun_post  &#39;$request_time - RealIP:$clientRealIp - [$time_local] $request - $status - $http_user_agent - $host - from:$http_referer - Request_Body:$request_body&#39;;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_19-根据域名设置root" tabindex="-1"><a class="header-anchor" href="#_19-根据域名设置root"><span>19.根据域名设置root</span></a></h3><p>需求：多个域名使用相同的配置，需要指定到不同root目录</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>www.a.com</span></span>
<span class="line"><span>www.b.com</span></span>
<span class="line"><span></span></span>
<span class="line"><span>root /data/wwwroot/web/$host/;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>解释：<code>/data/wwwroot/web/www.a.com/</code> 和 <code>/data/wwwroot/web/www.a.com/</code></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>set $host_pwd &quot;www.a.com&quot;;</span></span>
<span class="line"><span>if ( $host = &#39;www.b.com&#39; ) {</span></span>
<span class="line"><span>	set $host_pwd &quot;www.b.com&quot;;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>if ( $host = &#39;www.c.com&#39; ) {</span></span>
<span class="line"><span>	set $host_pwd &quot;www.c.com&quot;;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>root /data/wwwroot/web/$host_pwd/;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_20-判断二级域名" tabindex="-1"><a class="header-anchor" href="#_20-判断二级域名"><span>20.判断二级域名</span></a></h3><p>判断二级域名指定到不同的root目录</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>if ( $host ~* (\\b(?!www\\b)\\w+)\\.\\w+\\.\\w+ ) {</span></span>
<span class="line"><span>	set $subdomain $1;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>root /data/wwwroot/html/$subdomain/;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>server {</span></span>
<span class="line"><span>        listen       80 default;</span></span>
<span class="line"><span>        server_name _;</span></span>
<span class="line"><span>        access_log /data/wwwroot/log/ios-check-access.log main_aliyun;</span></span>
<span class="line"><span>        error_log /dev/null;</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>        location / {</span></span>
<span class="line"><span>                root /data/wwwroot/html/$host/;</span></span>
<span class="line"><span>                index index.html;</span></span>
<span class="line"><span>                expires max;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>     }</span></span>
<span class="line"><span>systemctl reload nginx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_21-nginx配置x-forwarded-for-防止伪造ip" tabindex="-1"><a class="header-anchor" href="#_21-nginx配置x-forwarded-for-防止伪造ip"><span>21.nginx配置X-Forwarded-For 防止伪造ip</span></a></h3><p>网上常见nginx配置ip请求头</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>风险： 用户可以通过自己设置请求头来伪造ip，比如用户在发起http请求是自己测试请求头 x-forwarded-for:192.168.0.151。那么服务器通过x-forwarded-for获取到的第一个ip就是用户伪造的ip。</p><p>防止伪造方案：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>情况1: 在只有1层nginx代理的情况下，设置nginx配置“proxy_set_header X-Forwarded-For $remote_addr;”。（此时$remote_addr获取的是用户的真是ip）</span></span>
<span class="line"><span>情况2：在有多层反向代理的情况下，</span></span>
<span class="line"><span>1）设置“最外层”nginx配置和情况1一样“proxy_set_header X-Forwarded-For $remote_addr;”。</span></span>
<span class="line"><span>2）除了“最外层”之外的nginx配置“proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;”。</span></span>
<span class="line"><span>　　这样就防止了用户通过伪造请求头来伪造真实ip。后台只需要从x-forwarded-for请求头中取出第一个ip就是用户的真实ip。后面如果有多个ip，就是反向代理的ip</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其他基础配置：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location ^~ /apk/ {</span></span>
<span class="line"><span>                access_log /data/wwwroot/log/www.test.com-access.log;</span></span>
<span class="line"><span>                alias /data/wwwroot/web/apk/;</span></span>
<span class="line"><span>                expires max;</span></span>
<span class="line"><span>        }	</span></span>
<span class="line"><span></span></span>
<span class="line"><span>location ~ /(resource|mediatorModule)/ {</span></span>
<span class="line"><span>                root    /opt/demo;</span></span>
<span class="line"><span>                expires max; 或者</span></span>
<span class="line"><span>    		   expires off;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="三、nginx-if-判断多条件" tabindex="-1"><a class="header-anchor" href="#三、nginx-if-判断多条件"><span>三、nginx if 判断多条件</span></a></h1><p>if指令该指令用来支持条件判断，并根据条件判断结果选择不同的Nginx配置。</p><table><thead><tr><th>语法</th><th>if (condition){...}</th></tr></thead><tbody><tr><td>默认值</td><td>—</td></tr><tr><td>位置</td><td>server、location</td></tr></tbody></table><h3 id="_1-变量名" tabindex="-1"><a class="header-anchor" href="#_1-变量名"><span>1.变量名</span></a></h3><p>如果变量名对应的值为空字符串或&quot;0&quot;，if都判断为false，其他条件为true。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>if ($param){</span></span>
<span class="line"><span></span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-使用-和-比较变量" tabindex="-1"><a class="header-anchor" href="#_2-使用-和-比较变量"><span>2.使用&quot;=&quot;和&quot;!=&quot;比较变量</span></a></h3><p>使用&quot;=&quot;和&quot;!=&quot;比较变量和字符串是否相等，满足条件为true，不满足为false</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>如果请求的方法等于POST则返回 405。</span></span>
<span class="line"><span>if ($request_method = POST){</span></span>
<span class="line"><span>	return 405;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-使用正则表达式对变量进行匹配" tabindex="-1"><a class="header-anchor" href="#_3-使用正则表达式对变量进行匹配"><span>3.使用正则表达式对变量进行匹配，</span></a></h3><p>匹配成功返回true，否则返回false。变量与正则表达式之间使用&quot;~&quot;,&quot;~<em>&quot;,&quot;!~&quot;,&quot;!~</em>&quot;来连接。</p><p>&quot;~&quot;代表匹配正则表达式过程中区分大小写，&quot;~*&quot;代表匹配正则表达式过程中不区分大小写</p><p>&quot;!~&quot;和&quot;!~*&quot;刚好和上面取相反值，如果匹配上返回false,匹配不上返回true</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>如果http_user_agent中包含MSIE则返回404</span></span>
<span class="line"><span>if ($http_user_agent ~ MSIE){</span></span>
<span class="line"><span>	#$http_user_agent的值中是否包含MSIE字符串，如果包含返回true</span></span>
<span class="line"><span>	return 404;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意：正则表达式字符串一般不需要加引号，但是如果字符串中包含&quot;}&quot;或者是&quot;;&quot;等字符时，就需要把引号加上。</p><h3 id="_4-判断请求的文件是否存在使用-f-和-f" tabindex="-1"><a class="header-anchor" href="#_4-判断请求的文件是否存在使用-f-和-f"><span>4. 判断请求的文件是否存在使用&quot;-f&quot;和&quot;!-f&quot;</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>if (-f $request_filename){</span></span>
<span class="line"><span>	#判断请求的文件是否存在</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>if (!-f $request_filename){</span></span>
<span class="line"><span>	#判断请求的文件是否不存在</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li><p>判断请求的目录是否存在使用&quot;-d&quot;和&quot;!-d&quot;</p></li><li><p>判断请求的目录或者文件是否存在使用&quot;-e&quot;和&quot;!-e&quot;</p></li><li><p>判断请求的文件是否可执行使用&quot;-x&quot;和&quot;!-x&quot;</p></li></ol><p>获取地址中的某个参数</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>if ($query_string ~ &quot;.*(?:^|\\?|&amp;)key=(.+?)(?:(?:&amp;.*)|$)&quot;) {</span></span>
<span class="line"><span>       set $key &quot;$1&quot;;</span></span>
<span class="line"><span> }</span></span>
<span class="line"><span>if ( $uid != $key ){</span></span>
<span class="line"><span>       return 301 &quot;https://smartgate.baoan.gov.cn/kshfwpt/H5app/index.html?key=\${uid}&quot;;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>地址比如是：</span></span>
<span class="line"><span>https://smartgate.baoan.gov.cn/kshfwpt/H5app/index.html?key=123&amp;method=256</span></span>
<span class="line"><span>则$key的值为123</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="nginx-if配合set做判断" tabindex="-1"><a class="header-anchor" href="#nginx-if配合set做判断"><span>nginx if配合set做判断</span></a></h3><p>在nginx配置文件中，可以使用if语句，但是对于else语句其实是不支持的，并且and条件和or条件也是不支持的</p><p>判断http_x_forwarded_for是否为空，如果为空则正常，如果不为空，则wordpress后台跳转。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>set $my_var &#39;2&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if ( $http_x_forwarded_for ~ ^$){</span></span>
<span class="line"><span>    set $my_var 1;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>if ( $my_var = 1) {</span></span>
<span class="line"><span>   #如果http_x_forwarded_for为空</span></span>
<span class="line"><span>   #rewrite ^/(.*)$ http://127.0.0.1/?11ab21s redirect;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>if ( $my_var = 2) {</span></span>
<span class="line"><span>    rewrite ^/wp-login.php(.*) http://127.0.0.1/?s1 redirect;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="nginx设置跳转rewrite" tabindex="-1"><a class="header-anchor" href="#nginx设置跳转rewrite"><span>nginx设置跳转rewrite</span></a></h2><p><strong>$1 $2 $3分别代表前面第一/二/三个()里的内容</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>http://www.nginx01.com/gm001 会跳转到  https://www.baidu.com/game?appid=001</span></span>
<span class="line"><span></span></span>
<span class="line"><span>server {</span></span>
<span class="line"><span>  listen       80;</span></span>
<span class="line"><span>  server_name  www.nginx01.com;</span></span>
<span class="line"><span>  </span></span>
<span class="line"><span>  rewrite ^/gm(.*)  https://www.baidu.com/game?appid=$1 redirect;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>其他：</span></span>
<span class="line"><span>rewrite ^/game-tg/rxzg-g(.*)$ http://tg.test.com/game-tg/txhc-g$1 redirect;</span></span>
<span class="line"><span>rewrite ^/game-tg/yg/gtjt-g(.*)/(.*)$ http://tg.test.com/game-tg/dhd-g6/$2 redirect;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="匹配链接参数跳转" tabindex="-1"><a class="header-anchor" href="#匹配链接参数跳转"><span>匹配链接参数跳转</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>if ( $query_string ~* ^from=dxw_a4$ ){</span></span>
<span class="line"><span>        rewrite ^/cps/game/gid/66  http://www.test.com/html/game-tg/gcld-g13/;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>http://www.nginx01.com/cps/game/gid/66?from=dxw_a4</span></span>
<span class="line"><span>会跳转到：</span></span>
<span class="line"><span>http://www.test.com/html/game-tg/gcld-g13/?from=dxw_a4</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="屏蔽参数带gid-90的链接" tabindex="-1"><a class="header-anchor" href="#屏蔽参数带gid-90的链接"><span>屏蔽参数带gid=90的链接</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>if ( $query_string ~* (.*)gid=90(.*) ){</span></span>
<span class="line"><span>	return 403;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>aaa.com/*.html的链接全部重定向到aaa.com/aaa/index.html;</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>rewrite &quot;^/(.*)\\.html$&quot; /aaa/$1.html break;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>/123456/xxxx 跳转 /xxxx?id=123456</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>rewrite ^/(/d+)/(.+)/ /$2?id=$1 last;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="rewrite指令-break-last-redirect-permanent" tabindex="-1"><a class="header-anchor" href="#rewrite指令-break-last-redirect-permanent"><span>rewrite指令(break,last,redirect,permanent)</span></a></h2><p>不写last和break - 那么流程就是依次执行这些rewrite</p><h3 id="_1-rewrite-break" tabindex="-1"><a class="header-anchor" href="#_1-rewrite-break"><span>1.rewrite break</span></a></h3><p>url重写后，直接使用当前资源，不再执行location里余下的语句，完成本次请求，地址栏url不变</p><p>break 终止匹配, 不再匹配后面的规则</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>if (!-e $request_filename) {</span></span>
<span class="line"><span>	rewrite ^(.*)$ /index.php?s=$1 last;</span></span>
<span class="line"><span>	break;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-rewrite-last" tabindex="-1"><a class="header-anchor" href="#_2-rewrite-last"><span>2.rewrite last</span></a></h3><p>url重写后，马上发起一个新的请求，再次进入server块，重试location匹配，超过10次匹配不到报500错误，地址栏url不变</p><p>last 相当于Apache里的[L]标记，表示完成rewrite</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>rewrite &quot;/category/(.*).html$&quot; /category/?cd=$1 last;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_3-rewrite-redirect" tabindex="-1"><a class="header-anchor" href="#_3-rewrite-redirect"><span>3.rewrite redirect</span></a></h3><p>返回302临时重定向，地址栏显示重定向后的url，爬虫不会更新url（因为是临时）</p><h3 id="_4-rewrite-permanent" tabindex="-1"><a class="header-anchor" href="#_4-rewrite-permanent"><span>4.rewrite permanent</span></a></h3><p>返回301永久重定向, 地址栏显示重定向后的url，爬虫更新url</p><h1 id="四、location中使用root和alias" tabindex="-1"><a class="header-anchor" href="#四、location中使用root和alias"><span>四、location中使用root和alias</span></a></h1><p>区别</p><h3 id="_1-alias指令只能在location块中使用-而root指令则不然" tabindex="-1"><a class="header-anchor" href="#_1-alias指令只能在location块中使用-而root指令则不然"><span>1.alias指令只能在location块中使用，而root指令则不然</span></a></h3><h3 id="_2-root指令会将location块的-url路径-带入到-root指令路径-中-将带入后的路径作为-最终路径-使用-最终路径-与url建立对应关系-alias指令则直接将location块的-url路径-与-alias指令路径-建立对应关系。" tabindex="-1"><a class="header-anchor" href="#_2-root指令会将location块的-url路径-带入到-root指令路径-中-将带入后的路径作为-最终路径-使用-最终路径-与url建立对应关系-alias指令则直接将location块的-url路径-与-alias指令路径-建立对应关系。"><span>2.root指令会将location块的”url路径”带入到”root指令路径”中，将带入后的路径作为”最终路径”，使用”最终路径”与url建立对应关系，alias指令则直接将location块的”url路径”与”alias指令路径”建立对应关系。</span></a></h3><h2 id="root示例1" tabindex="-1"><a class="header-anchor" href="#root示例1"><span>root示例1</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location /demo {</span></span>
<span class="line"><span>    root /opt/test;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>location块匹配的url为”/demo”，root指令的路径为”/opt/test”，那么，根据上述配置，当我们访问”/demo”这个url时，实际上访问的到底是服务器中的哪个路径呢？答案是”/opt/test/demo”路径</p><p>实验一下</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>mkdir -p /opt/test/demo</span></span>
<span class="line"><span>echo &#39;test&#39; &gt; /opt/test/index.html</span></span>
<span class="line"><span>echo &#39;demo&#39; &gt;/opt/test/demo/index.html</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>访问</p><p><img src="https://imgoss.xgss.net/picgo/image-20220624140721523.png?aliyun" alt="image-20220624140721523"></p><p>访问 /demo/ 实际是在访问 ‘/opt/test/demo/’。</p><h2 id="alias示例2" tabindex="-1"><a class="header-anchor" href="#alias示例2"><span>alias示例2</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>location /demo1 {</span></span>
<span class="line"><span>    alias /opt/test;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>访问</p><p><img src="https://imgoss.xgss.net/picgo/image-20220624140949024.png?aliyun" alt="image-20220624140949024"></p><p>访问 /demo1/ 实际是在访问 ‘/opt/test/’。 location的url是与alias的路径完全对等的。</p>`,173)]))}const c=a(l,[["render",p]]),h=JSON.parse('{"path":"/article/1xkithk0/","title":"Nginx从入门到放弃06-Nginx的N种特别实用示例","lang":"en-US","frontmatter":{"title":"Nginx从入门到放弃06-Nginx的N种特别实用示例","createTime":"2025/05/27 17:51:17","permalink":"/article/1xkithk0/"},"git":{"createdTime":1749111496000,"updatedTime":1750129445000,"contributors":[{"name":"star","username":"star","email":"star@xgss.net","commits":2,"url":"https://github.com/star"}]},"readingTime":{"minutes":10.62,"words":3187},"filePathRelative":"nginx/Nginx从入门到放弃06-Nginx的N种特别实用示例.md"}');export{c as comp,h as data};
