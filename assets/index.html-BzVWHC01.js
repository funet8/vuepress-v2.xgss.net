import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as n,a as e,o as i}from"./app-BiQR_lPj.js";const l={};function p(r,s){return i(),n("div",null,s[0]||(s[0]=[e(`<h1 id="使用xtrabackup将阿里云的mysql5-7备份文件恢复到自建服务器" tabindex="-1"><a class="header-anchor" href="#使用xtrabackup将阿里云的mysql5-7备份文件恢复到自建服务器"><span>使用XtraBackup将阿里云的MySQL5.7备份文件恢复到自建服务器</span></a></h1><p>最近有个任务是需要把阿里云rds数据库备份再转移到ecs服务器中，本篇文章是通过官方网站上再结合自己的操作笔记备忘。</p><p>RDS数据库的版本是 myql5.7，ECS服务器上的版本是mysql5.7</p><p><img src="https://imgoss.xgss.net/picgo/image-20221130155249636.png?aliyun" alt="image-20221130155249636"></p><h1 id="一、备份前的准备" tabindex="-1"><a class="header-anchor" href="#一、备份前的准备"><span>一、备份前的准备</span></a></h1><h2 id="_1-ecs安装mysql5-7" tabindex="-1"><a class="header-anchor" href="#_1-ecs安装mysql5-7"><span>1.ECS安装mysql5.7</span></a></h2><p>如果安装了，请忽略。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>Centos7系统下编译安装Mysql5.7</span></span>
<span class="line"><span># wget https://gitee.com/funet8/MYSQL/raw/master/Mysql_Shell/CentOS7_Install_mysql5_7.sh</span></span>
<span class="line"><span># sh CentOS7_Install_mysql5_7.sh</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-ecs安装percona-xtrabackup" tabindex="-1"><a class="header-anchor" href="#_2-ecs安装percona-xtrabackup"><span>2.ECS安装Percona XtraBackup</span></a></h2><p>对于MySQL 5.7、5.6或5.5实例：安装<a href="https://docs.percona.com/percona-xtrabackup/2.4/installation/apt_repo.html?spm=a2c4g.11186623.0.0.6e0077b8JxzrRj" target="_blank" rel="noopener noreferrer">Percona XtraBackup 2.4</a>。</p><p>对于MySQL 8.0实例，安装 <a href="https://docs.percona.com/percona-xtrabackup/8.0/installation/apt_repo.html" target="_blank" rel="noopener noreferrer">Percona XtraBackup 8.0</a>。</p><p>我这边安装Percona XtraBackup 2.4 <a href="https://docs.percona.com/percona-xtrabackup/2.4/installation/yum_repo.html" target="_blank" rel="noopener noreferrer">参考网站</a>：https://docs.percona.com/percona-xtrabackup/2.4/installation/yum_repo.html</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>安装percona-release配置工具：</span></span>
<span class="line"><span>root您可以通过以用户身份或使用 以下命令运行以下命令来安装 percona-release 的 yum 存储库</span></span>
<span class="line"><span># yum install -y https://repo.percona.com/yum/percona-release-latest.noarch.rpm</span></span>
<span class="line"><span></span></span>
<span class="line"><span>测试存储库:</span></span>
<span class="line"><span># yum list | grep percona</span></span>
<span class="line"><span></span></span>
<span class="line"><span>启用存储库：</span></span>
<span class="line"><span>如果Percona XtraBackup 打算与上游 MySQL 服务器结合使用，您只需要启用tools 存储库：</span></span>
<span class="line"><span># percona-release enable-only tools</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过运行安装Percona XtraBackup</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># yum install -y percona-xtrabackup-24</span></span>
<span class="line"><span></span></span>
<span class="line"><span># xtrabackup -version</span></span>
<span class="line"><span>xtrabackup: recognized server arguments: --datadir=/var/lib/mysql </span></span>
<span class="line"><span>xtrabackup version 2.4.26 based on MySQL server 5.7.35 Linux (x86_64) (revision id: 19de43b)</span></span>
<span class="line"><span>Percona XtraBackup 安装成功。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-安装解压工具qpress" tabindex="-1"><a class="header-anchor" href="#_3-安装解压工具qpress"><span>3.安装解压工具qpress</span></a></h2><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>wget &quot;http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/183466/cn_zh/1608011575185/qpress-11-linux-x64.tar&quot;</span></span>
<span class="line"><span>tar xvf qpress-11-linux-x64.tar</span></span>
<span class="line"><span>chmod 775 qpress</span></span>
<span class="line"><span>cp qpress /usr/bin</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="二、下载备份" tabindex="-1"><a class="header-anchor" href="#二、下载备份"><span>二、下载备份</span></a></h1><p>进入RDS数据库---&gt;实例列表---&gt;备份恢复</p><p><img src="https://imgoss.xgss.net/picgo/image-20221130112725052.png?aliyun" alt="image-20221130112725052"></p><p>复制内网地址，公网是需要收费的。</p><p><img src="https://imgoss.xgss.net/picgo/image-20221130112852629.png?aliyun" alt="image-20221130112852629"></p><p>在Linux服务器上，执行如下命令下载物理备份。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># wget -c &#39;http://...&#39; -O test1_qp.xb</span></span>
<span class="line"><span></span></span>
<span class="line"><span>命令：</span></span>
<span class="line"><span># wget -c &#39;http://rdsbak-st-v2.oss-cn-shenzhen-internal.aliyuncs.com/custins34273877/hins19034500_data_20221129104523_qp.xb?Expires=******************************************************&amp;Region=cn-shenzhen&#39; -O test1_qp.xb</span></span>
<span class="line"><span></span></span>
<span class="line"><span># ll -h test1_qp.xb </span></span>
<span class="line"><span>-rw-r--r-- 1 root root 8.7G Nov 29 10:48 test1_qp.xb</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="二、解压和恢复备份" tabindex="-1"><a class="header-anchor" href="#二、解压和恢复备份"><span>二、解压和恢复备份</span></a></h1><p>1.在Linux服务器上，创建一个目录（例如/home/mysql/data）用于存放解压后的文件。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>mkdir -p /home/mysql/data</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>2.解压压缩包。根据压缩包的后缀选择解压命令。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>## 先解包</span></span>
<span class="line"><span>cat test1_qp.xb | xbstream -x -v -C /home/mysql/data  【已执行】</span></span>
<span class="line"><span></span></span>
<span class="line"><span>## 然后解压</span></span>
<span class="line"><span>### 对于MySQL 5.6/5.7</span></span>
<span class="line"><span>innobackupex --decompress --remove-original /home/mysql/data 【已执行】</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://imgoss.xgss.net/picgo/image-20221130144623802.png?aliyun" alt="image-20221130144623802"></p><p>说明 您可以把test1和/home/mysql/data替换为实际的文件名和路径。</p><p>3.执行如下命令，查询解压后生成的文件。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>ls -l /home/mysql/data</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>4.执行如下命令，恢复解压好的备份文件。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>## MySQL 5.6/5.7</span></span>
<span class="line"><span>innobackupex --defaults-file=/home/mysql/data/backup-my.cnf --apply-log /home/mysql/data 【已执行】</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://imgoss.xgss.net/picgo/image-20221130145751052.png?aliyun" alt="image-20221130145751052"></p><p>1.恢复时请耐心等待，若系统返回如下类似结果，则说明备份文件已成功恢复到自建数据库。</p><p><img src="https://imgoss.xgss.net/picgo/p47412.jpg?aliyun" alt="img"></p><p>2.若系统返回<code>xtrabackup: Unknown error 3613</code>，请将Percona XtraBackup更新到最新版本后再次尝试。</p><p>3.若系统返回如下报错，可以用<code>rm -rf /var/lib/mysql</code>命令清空文件夹内文件，然后用<code>chown -R mysql:mysql /var/lib/mysql</code>修改权限。</p><p><img src="https://imgoss.xgss.net/picgo/p187242.png?aliyun" alt="img"></p><p>4.若系统返回如下报错，请参见<a href="https://help.aliyun.com/document_detail/41817.html?spm=5176.19908310.help.dexternal.6fbe1450ernae5#section-ooe-3fz-r97" target="_blank" rel="noopener noreferrer">前提条件</a>中的第2项说明。</p><p><img src="https://imgoss.xgss.net/picgo/p298939.png?aliyun" alt="恢复失败"></p><h1 id="三、启动mysql" tabindex="-1"><a class="header-anchor" href="#三、启动mysql"><span>三、启动MySQL</span></a></h1><p>1.为避免版本问题，需修改backup-my.cnf文件，具体操作步骤如下。</p><p>执行如下命令，以文本方式编辑backup-my.cnf文件。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span># vi /home/mysql/data/backup-my.cnf</span></span>
<span class="line"><span>添加如下参数：</span></span>
<span class="line"><span>lower_case_table_names=1</span></span>
<span class="line"><span>port = 61922</span></span>
<span class="line"><span>datadir=/home/mysql/data</span></span>
<span class="line"><span>        </span></span>
<span class="line"><span>注释掉如下自建数据库不支持的参数：</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#innodb_log_checksum_algorithm</span></span>
<span class="line"><span>#innodb_fast_checksum</span></span>
<span class="line"><span>#innodb_log_block_size</span></span>
<span class="line"><span>#innodb_doublewrite_file</span></span>
<span class="line"><span>#innodb_encrypt_algorithm</span></span>
<span class="line"><span>#rds_encrypt_data</span></span>
<span class="line"><span>#redo_log_version</span></span>
<span class="line"><span>#master_key_id</span></span>
<span class="line"><span>#server_uuid</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>说明 如果自建数据库使用的是MyISAM引擎，无法兼容阿里云的InnoDB，则需要多注释掉如下参数并增加skip-grant-tables参数：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>#innodb_log_checksum_algorithm=strict_crc32</span></span>
<span class="line"><span>#redo_log_version=1</span></span>
<span class="line"><span>skip-grant-tables</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>按Esc键，然后输入:wq并回车进行保存。</p><p>2.执行如下命令，修改文件属主，并确定文件所属为MySQL用户。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>chown -R mysql:mysql /home/mysql/data</span></span>
<span class="line"><span></span></span>
<span class="line"><span>执行如下命令，启动MySQL进程。</span></span>
<span class="line"><span>mysqld --defaults-file=/home/mysql/data/backup-my.cnf --user=mysql --datadir=/home/mysql/data &amp;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>关闭本地的mysql否则会报错</span></span>
<span class="line"><span>[ERROR] Another process with pid 27300 is using unix socket file.</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span># netstat -tunpl|grep mysql</span></span>
<span class="line"><span>tcp6       0      0 :::61922                :::*                    LISTEN      9366/mysqld    </span></span>
<span class="line"><span>恢复成功。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://imgoss.xgss.net/picgo/image-20221130150908531.png?aliyun" alt="image-20221130150908531"></p><p>root密码问题：</p><ul><li><p>如果您的实例版本为MySQL 5.5或5.6，需要重置root密码方可正常使用。更多信息，请参见<a href="https://dev.mysql.com/doc/refman/8.0/en/resetting-permissions.html" target="_blank" rel="noopener noreferrer">官方文档</a>。</p></li><li><p>如果您的实例版本为MySQL 5.7或8.0，则root密码即自建库的root密码。</p></li><li><p>如果启动MySQL进程报错，可以尝试修改存储引擎。更多信息，请参见<a href="https://help.aliyun.com/document_detail/41817.html?spm=5176.19908310.help.dexternal.6fbe1450ernae5#section-ohm-rf7-3mx" target="_blank" rel="noopener noreferrer">常见问题</a>。</p></li></ul><p>登录MySQL数据库以验证进程启动成功</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>mysql -u&lt;源RDS实例账号&gt; -p&lt;对应密码&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># mysql -u&lt;源RDS实例账号&gt; -h127.0.0.1 -P 61922 -p&lt;对应密码&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>mysql -uxshd_mysql -h127.0.0.1 -P 61922 -p</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进入数据库：</p><p><img src="https://imgoss.xgss.net/picgo/image-20221130151418406.png?aliyun" alt="image-20221130151418406"></p><h1 id="通过binlog日志恢复数据" tabindex="-1"><a class="header-anchor" href="#通过binlog日志恢复数据"><span>通过binlog日志恢复数据</span></a></h1><p>1.下载binlog日志</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>wget -c &#39;URL路径&#39; -O /data/tmp/binlog/mysql-bin1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>2.导入数据库</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>mysqlbinlog  -d 指定数据库</span></span>
<span class="line"><span>mysql -f 忽略报错，强制导入</span></span>
<span class="line"><span>mysqlbinlog  -d &#39;指定数据库&#39;  /data/tmp/binlog/mysql-bin1 | mysql -u root -P61922 -f</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="参考文档" tabindex="-1"><a class="header-anchor" href="#参考文档"><span>参考文档</span></a></h1><p>官方帮助文档：</p><p><a href="https://help.aliyun.com/knowledge_detail/41817.html" target="_blank" rel="noopener noreferrer">阿里云-RDS MySQL物理备份文件恢复到自建数据库</a></p><p>https://help.aliyun.com/knowledge_detail/41817.html</p>`,68)]))}const c=a(l,[["render",p]]),h=JSON.parse('{"path":"/article/8998gji0/","title":"使用XtraBackup将阿里云的MySQL5.7备份文件恢复到自建服务器","lang":"en-US","frontmatter":{"title":"使用XtraBackup将阿里云的MySQL5.7备份文件恢复到自建服务器","createTime":"2025/05/27 17:51:17","permalink":"/article/8998gji0/"},"git":{"createdTime":1749111496000,"updatedTime":1760001321000,"contributors":[{"name":"star","username":"star","email":"star@xgss.net","commits":3,"url":"https://github.com/star"}]},"readingTime":{"minutes":4.34,"words":1303},"filePathRelative":"mysql/使用XtraBackup将阿里云的MySQL5.7备份文件恢复到自建服务器.md"}');export{c as comp,h as data};
